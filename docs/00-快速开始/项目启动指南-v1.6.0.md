# 旅居服务站项目启动指南 v1.6.0

**最后更新**: 2026-03-01
**适用版本**: v1.6.0 及以上
**对象**: 新加入的开发人员

---

## 一、项目概况

### 1.1 项目简介

**项目名称**: 旅居服务站小程序
**项目类型**: 微信小程序（uni-app 框架）
**核心功能**: 房源预订、技能交易、社区广场、消息通知
**技术栈**: uni-app + Express.js + MySQL + CloudBase

### 1.2 项目架构

```
┌─────────────────────────────────────────┐
│   微信小程序前端（uni-app）              │
│   - 5个Tab模块（民宿/广场/技能/消息/我的） │
│   - 40+个页面                           │
│   - 10+个可复用组件                     │
└────────────────┬────────────────────────┘
                 │ HTTPS/WebSocket
      ┌──────────┴──────────┐
      ▼                     ▼
┌─────────────┐      ┌──────────────┐
│ Express后端  │      │  CloudBase   │
│ localhost:  │      │  云数据库     │
│ 3000        │      │  云存储       │
└─────────────┘      └──────────────┘
```

---

## 二、开发环境配置

### 2.1 必需环境

| 工具 | 版本 | 用途 |
|------|------|------|
| **Node.js** | v24.x | 运行环境 |
| **npm** | v10.x | 包管理 |
| **HBuilder** | 最新 | 小程序开发工具 |
| **微信开发者工具** | 最新 | 小程序预览/调试 |
| **MySQL** | 8.0+ | 数据库 |
| **Git** | 2.40+ | 版本控制 |

### 2.2 快速安装

#### 2.2.1 克隆项目

```bash
# 克隆仓库
git clone <repository-url> 旅居服务站
cd 旅居服务站

# 查看分支
git branch -a

# 切换到 develop 分支
git checkout develop
```

#### 2.2.2 后端环境配置

```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 创建 .env 文件
cp .env.example .env

# 编辑 .env 配置
# 需要配置：
# - DB_HOST=localhost
# - DB_USER=root
# - DB_PASSWORD=your_password
# - DB_NAME=travel_service
# - JWT_SECRET=your_secret_key
```

#### 2.2.3 数据库初始化

```bash
# 使用提供的 SQL 文件初始化数据库
mysql -u root -p travel_service < backend/database.sql

# 或在 MySQL 客户端中执行
mysql> USE travel_service;
mysql> SOURCE backend/database.sql;
```

#### 2.2.4 启动后端服务

```bash
# 在 backend 目录执行
npm start

# 或使用开发模式（自动重启）
npm run dev

# 验证后端是否运行正常
# 访问: http://localhost:3000/api/health
# 应返回: { status: 'ok' }
```

#### 2.2.5 小程序项目配置

1. 打开 HBuilder
2. 打开项目文件夹：`d:\Desktop\校园\挑战杯\旅居服务站`
3. 配置 `app.js` 中的云开发环境 ID

```javascript
// app.js 第一行
wx.cloud.init({
  env: 'your-cloud-env-id',  // 替换为实际的环境 ID
  traceUser: true
})
```

---

## 三、项目结构

### 3.1 前端目录结构

```
旅居服务站/
├── pages/                    # 页面目录
│   ├── index/               # 首页
│   ├── home/                # 民宿模块
│   ├── square/              # 广场模块
│   ├── skill/               # 技能模块
│   ├── message/             # 消息模块
│   ├── profile/             # 个人中心
│   └── ...
├── components/              # 可复用组件
│   ├── comment-modal/       # 评论弹框
│   ├── identity-badge/      # 身份徽章
│   └── post-card/           # 帖子卡片
├── services/                # 业务服务层
│   ├── houseService.js      # 民宿服务
│   ├── postService.js       # 帖子服务
│   ├── likeService.js       # 点赞服务
│   ├── favoriteService.js   # 收藏服务
│   ├── followService.js     # 关注服务
│   ├── historyService.js    # 历史服务
│   ├── skillService.js      # 技能服务
│   └── ...
├── utils/                   # 工具函数
│   ├── cloud.js             # 云开发配置
│   ├── auth.js              # 认证相关
│   └── mock.js              # 模拟数据
├── styles/                  # 全局样式
├── images/                  # 图片资源
├── app.js                   # 应用入口
├── app.json                 # 应用配置
└── project.config.json      # 小程序配置
```

### 3.2 后端目录结构

```
backend/
├── src/
│   ├── app.js               # 应用主文件
│   ├── config/
│   │   └── database.js      # 数据库配置
│   ├── controllers/         # 控制器层
│   │   ├── authController.js
│   │   ├── userController.js
│   │   ├── orderController.js
│   │   └── messageController.js
│   ├── middleware/          # 中间件
│   │   ├── auth.js          # JWT 认证
│   │   ├── errorHandler.js  # 错误处理
│   │   ├── rateLimit.js     # 限流
│   │   └── validate.js      # 参数验证
│   ├── models/              # 数据模型
│   │   ├── user.js
│   │   ├── order.js
│   │   └── message.js
│   ├── routes/              # 路由
│   │   ├── auth.js
│   │   ├── user.js
│   │   ├── order.js
│   │   └── message.js
│   ├── services/            # 业务服务
│   │   └── uploadService.js
│   └── utils/
│       ├── errors.js        # 错误类
│       └── logger.js        # 日志
├── test/                    # 测试文件
│   ├── api.test.js
│   ├── integration.test.js
│   ├── order.test.js
│   └── message.test.js
├── database.sql             # 数据库脚本
├── package.json
├── .env                     # 环境配置
└── .env.example
```

---

## 四、核心概念

### 4.1 双通道架构

项目采用**自建后端 + 云开发**的双通道架构设计：

```
判断 Token 存在？
  ├─ 是 → 调用自建后端（HTTP API）
  │       └─ 处理：认证、用户、订单、消息等复杂业务
  └─ 否 → 调用云开发（CloudBase）
          └─ 处理：房源、帖子、点赞、收藏等简单操作
```

### 4.2 服务层隔离

所有业务逻辑都通过 `services/` 目录中的服务文件封装：

```javascript
// 示例：发布房源
const houseService = require('./services/houseService.js')

// 调用服务发布房源
const houseId = await houseService.publishHouse({
  title: '三亚海景房',
  price: 299,
  // ...
})

// 服务层会自动处理：
// 1. 先保存到本地存储
// 2. 尝试同步到云数据库
// 3. 同步失败则使用本地数据
```

### 4.3 降级机制

每个服务都实现了"云端 + 本地"的降级：

```
发布房源
  ├─ 保存到本地存储 (100% 成功)
  └─ 尝试上传到云数据库
      ├─ 成功 ✅
      └─ 失败 → 使用本地数据 (自动降级)
```

---

## 五、开发工作流

### 5.1 日常开发流程

#### 步骤一：创建功能分支

```bash
# 从 develop 分支创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/your-feature-name

# 分支命名规范：
# feature/房源列表优化
# fix/评论页面布局问题
# docs/API文档更新
```

#### 步骤二：本地开发

```bash
# 在 HBuilder 中编辑代码
# 或使用任何文本编辑器修改代码

# 使用微信开发者工具预览效果
# 快捷键：Ctrl+B
```

#### 步骤三：提交代码

```bash
# 检查修改
git status

# 暂存改动
git add .

# 提交代码（务必写清楚提交信息）
git commit -m "feat: 优化房源列表加载速度"

# 推送到远程分支
git push origin feature/your-feature-name
```

#### 步骤四：创建 Pull Request

1. 打开 GitHub/GitLab 仓库
2. 创建 PR：from `feature/your-feature-name` to `develop`
3. 填写 PR 描述（说明修改内容、测试情况）
4. 等待代码审核
5. 合并到 `develop` 分支

### 5.2 提交消息规范

```
格式：<类型>(<范围>): <主题>

类型：
  feat     - 新功能
  fix      - 修复 bug
  docs     - 文档更新
  style    - 代码格式（不改逻辑）
  refactor - 重构
  test     - 测试相关
  chore    - 构建/依赖/工具

范围：
  cloud    - 云开发相关
  backend  - 后端相关
  ui       - UI 组件
  service  - 业务服务
  page     - 页面相关

示例：
  feat(cloud): 添加点赞服务本地存储降级
  fix(page): 修复房源详情页图片加载问题
  docs(api): 更新 API 文档
```

---

## 六、常见任务

### 6.1 添加新的服务

#### 场景：需要开发"评分"功能

```javascript
// 创建 services/scoreService.js
const LOCAL_STORAGE_KEY = 'local_scores'

let cloudModule = null
try {
  cloudModule = require('../utils/cloud.js')
} catch (e) {
  console.log('[scoreService] 云开发模块不可用')
}

// 本地存储方法
function getLocalScores() {
  try {
    return wx.getStorageSync(LOCAL_STORAGE_KEY) || []
  } catch (e) {
    return []
  }
}

// 云开发方法
async function saveCloudScore(scoreData) {
  const { db } = cloudModule
  // 不要手动设置 _openid，系统会自动添加
  const data = {
    ...scoreData,
    createTime: db.serverDate()
  }
  const res = await db.collection('scores').add({ data })
  return res._id
}

// 统一接口（带降级）
function submitScore(scoreData) {
  saveLocalScore(scoreData)
  
  if (cloudModule && cloudModule.db) {
    return saveCloudScore(scoreData).catch(err => {
      console.log('[scoreService] 云端保存失败，已保存到本地')
      return true
    })
  }
  
  return Promise.resolve(true)
}

module.exports = {
  submitScore,
  getLocalScores
}
```

### 6.2 修改数据库表结构

#### 场景：需要在 users 表中添加新字段

```sql
-- 编辑 backend/database.sql
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
ALTER TABLE users ADD COLUMN address VARCHAR(255);

-- 重新初始化数据库
mysql -u root -p travel_service < backend/database.sql
```

### 6.3 添加新的 API 端点

#### 场景：需要实现"获取用户统计"接口

```javascript
// 1. 创建控制器方法
// backend/src/controllers/userController.js
async function getUserStats(req, res, next) {
  try {
    const userId = req.user.id
    const stats = await userModel.getUserStats(userId)
    res.json({
      code: 200,
      data: stats
    })
  } catch (error) {
    next(error)
  }
}

// 2. 创建模型方法
// backend/src/models/user.js
async function getUserStats(userId) {
  const conn = await getConnection()
  const [rows] = await conn.execute(
    `SELECT COUNT(*) as houseCount, COUNT(DISTINCT item_id) as favoriteCount 
     FROM orders WHERE user_id = ?`,
    [userId]
  )
  return rows[0]
}

// 3. 添加路由
// backend/src/routes/user.js
router.get('/stats', verifyAccessToken, userController.getUserStats)

// 4. 测试 API
// 访问: GET http://localhost:3000/api/user/stats
```

---

## 七、测试指南

### 7.1 后端 API 测试

```bash
# 运行所有测试
cd backend
npm test

# 查看测试覆盖率
npm run test:coverage

# 单独运行某个测试文件
npm test -- test/api.test.js
```

### 7.2 小程序功能测试

| 功能 | 测试步骤 | 预期结果 |
|------|---------|---------|
| 房源发布 | 1. 进入"发布房源"页面<br>2. 填写房源信息<br>3. 点击发布 | 房源成功上传到云数据库 |
| 点赞功能 | 1. 打开帖子详情<br>2. 点击点赞按钮<br>3. 检查本地存储 | 点赞数 +1，本地存储保存 |
| 收藏功能 | 1. 打开房源详情<br>2. 点击收藏<br>3. 进入"我的收藏" | 房源出现在收藏列表 |
| 搜索功能 | 1. 进入搜索页面<br>2. 输入关键词<br>3. 查看结果 | 返回相关房源/帖子列表 |

### 7.3 调试技巧

#### 查看云数据库数据

```bash
# 在微信开发者工具中
# 1. 打开微信开发者工具
# 2. 点击 "云开发" 按钮
# 3. 选择 "数据库"
# 4. 选择集合查看数据
```

#### 查看后端日志

```bash
# 后端自动输出日志，格式如下：
[2026-03-01 10:30:45] INFO: 用户登录成功, userId=123
[2026-03-01 10:30:46] ERROR: 数据库连接失败: ECONNREFUSED

# 查看详细日志文件
cat backend/logs/app.log
```

#### 小程序调试

```javascript
// 在页面中添加调试代码
console.log('调试信息:', data)

// 在微信开发者工具的控制台查看输出
// 快捷键：F12
```

---

## 八、常见问题排查

### 问题一：后端启动失败

**症状**：`Error: connect ECONNREFUSED 127.0.0.1:3306`

**解决**：
1. 确保 MySQL 服务已启动
2. 检查 `.env` 文件中的数据库配置
3. 验证数据库是否已创建

### 问题二：云数据库操作失败

**症状**：`errCode: -502005 database collection not exists`

**解决**：
1. 打开微信开发者工具云开发控制台
2. 确认 9 个集合是否已创建
3. 检查集合权限设置

### 问题三：图片加载超时

**症状**：`[渲染层网络层错误] Failed to load image`

**解决**：
- 检查图片 URL 是否可访问
- 使用国内 CDN 或本地存储
- 确认网络连接正常

### 问题四：Token 验证失败

**症状**：`401 Unauthorized`

**解决**：
1. 确保已正确登录
2. 检查 Token 是否过期
3. 验证请求头中 Authorization 字段格式

---

## 九、部署指南

### 9.1 小程序部署

```bash
# 1. 在 HBuilder 中
# 菜单：发行 → 小程序

# 2. 选择微信小程序
# 3. 输入小程序 AppID
# 4. 选择部署版本
# 5. 点击发行

# 部署完成后在微信公众平台上线
```

### 9.2 后端部署

```bash
# 1. 在服务器上克隆项目
git clone <repository-url>

# 2. 安装依赖
cd backend
npm install --production

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 4. 启动服务（使用 PM2）
npm install -g pm2
pm2 start app.js --name "travel-service"

# 5. 设置开机自启
pm2 startup
pm2 save
```

---

## 十、参考资源

### 10.1 文档

| 文档 | 位置 |
|------|------|
| API 设计文档 | `docs/06-API设计/` |
| 项目架构 | `docs/06-API设计/API与数据库设计文档.md` |
| 云开发设计 | `docs/06-API设计/云开发设计方案.md` |
| 更新记录 | `docs/04-更新记录/` |

### 10.2 外部资源

| 资源 | 链接 |
|------|------|
| uni-app 官方文档 | https://uniapp.dcloud.net.cn/ |
| Express.js 文档 | https://expressjs.com/ |
| CloudBase 文档 | https://docs.cloudbase.net/ |
| MySQL 文档 | https://dev.mysql.com/doc/ |
| Git 教程 | https://git-scm.com/book/zh/v2 |

---

## 十一、联系与支持

### 11.1 团队沟通

- **技术讨论**: 项目 Wiki / Issues
- **进度同步**: 周一、周三、周五 10:00
- **紧急问题**: 群里 @技术负责人

### 11.2 常见联系人

| 角色 | 名字 | 职责 |
|------|------|------|
| 技术负责人 | - | 整体架构、技术决策 |
| 前端负责人 | - | 小程序开发、UI 优化 |
| 后端负责人 | - | API 开发、数据库 |
| 云开发负责人 | - | 云函数、数据库集合 |

---

## 十二、快速检查清单

### 部署前检查

- [ ] Node.js 版本 ≥ 24.x
- [ ] MySQL 服务已启动
- [ ] .env 文件已配置
- [ ] 数据库已初始化
- [ ] 后端服务成功启动 (port 3000)
- [ ] 云开发环境 ID 已配置
- [ ] 所有 9 个云数据库集合已创建
- [ ] 索引已添加到相关集合

### 开发前检查

- [ ] 已切换到 develop 分支
- [ ] 已创建功能分支
- [ ] 已安装项目依赖
- [ ] 后端和前端都能正常启动
- [ ] 可以在微信开发者工具中预览小程序

---

## 十三、常用命令速查

```bash
# 后端相关
cd backend
npm install              # 安装依赖
npm start               # 启动服务
npm test                # 运行测试
npm run dev             # 开发模式（自动重启）

# 前端相关
git clone <url>         # 克隆项目
git checkout develop    # 切换分支
git pull origin develop # 更新代码
git checkout -b feature/xxx  # 创建功能分支

# 数据库相关
mysql -u root -p        # 连接 MySQL
SOURCE backend/database.sql  # 导入数据库
```

---

## 十四、下一步

### 新成员建议

1. ✅ 先读完这份指南
2. ✅ 按照"2.2 快速安装"部分配置环境
3. ✅ 启动后端和前端服务
4. ✅ 在微信开发者工具中预览小程序
5. ✅ 熟悉项目代码结构
6. ✅ 运行测试用例验证环境
7. ✅ 选择一个简单的 bug 或功能开始开发

### 学习资源

- 查看现有代码如何实现功能
- 参考相似功能的实现方式
- 查看测试文件理解功能需求
- 阅读提交历史了解开发演进

---

**文档版本**: v1.6.0
**最后更新**: 2026-03-01
**维护人**: 技术团队

如有问题，请通过以下方式联系：
1. 项目 Issues 提出问题
2. 团队群里讨论
3. 找技术负责人咨询
