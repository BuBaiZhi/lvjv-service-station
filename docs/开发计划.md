# 旅居服务站开发计划

> 文档版本：v1.0  
> 更新日期：2026-02-26  
> 项目名称：旅居服务站（游牧鸟）

---

## 一、项目概述

### 1.1 项目定位

旅居服务站是一个面向数字游民、旅居人群的微信小程序平台，提供：
- **房源服务**：民宿短租、长租房源发布与预订
- **社区广场**：找搭子、活动组织、技能变现
- **用户中心**：个人资料、发布管理、收藏历史

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序前端                          │
│  原生开发 + CSS Variables 主题系统 + 模块化服务层            │
├─────────────────────────────────────────────────────────────┤
│  authModel.js - 统一认证层                                   │
│  ├── HTTP 后端（权威身份源）→ 用户认证、敏感操作              │
│  └── 云开发（数据存储）→ 房源、帖子、评论等业务数据           │
└─────────────────────────────────────────────────────────────┘
                    ↓                    ↓
        ┌──────────────────┐    ┌──────────────────┐
        │   自建后端        │    │   云开发          │
        │   Express+MySQL  │    │   腾讯云TCB       │
        ├──────────────────┤    ├──────────────────┤
        │ ✓ 用户认证       │    │ ✓ 房源数据        │
        │ ✓ 权限管理       │    │ ✓ 帖子数据        │
        │ ✓ 敏感操作       │    │ ✓ 评论收藏        │
        │ ✓ 后台管理       │    │ ✓ 文件存储        │
        │ ✓ 数据分析       │    │ ✓ 实时订阅        │
        └──────────────────┘    └──────────────────┘
```

### 1.3 目标用户

| 用户类型 | 描述 | 核心需求 |
|----------|------|----------|
| 村民 | 当地居民/房东 | 发布房源、提供服务、赚取收入 |
| 游民 | 数字游民/旅居者 | 找房源、找搭子、参与活动 |
| 管理员 | 平台运营者 | 审核内容、管理用户、数据分析 |

---

## 二、当前项目状态

### 2.1 页面模块统计

| 模块 | 页面数 | 完成度 | 数据源 | 主要文件 |
|------|--------|--------|--------|----------|
| 首页 | 2 | 85% | 模拟数据 | pages/home/ |
| 房源 | 5 | 70% | 模拟数据 | pages/house/ |
| 广场 | 6 | 80% | 模拟数据 | pages/square/ |
| 用户中心 | 8 | 60% | 本地存储 | pages/user/ |
| 登录认证 | 2 | 90% | 降级处理 | pages/auth/ |
| 管理后台 | 4 | 30% | 无 | pages/admin/ |
| 公共页面 | 1 | 100% | 无 | pages/common/ |

### 2.2 服务层统计

| 服务文件 | 功能 | 状态 |
|----------|------|------|
| houseService.js | 房源数据 | 模拟模式 |
| postService.js | 帖子数据 | 模拟模式 |
| userService.js | 用户数据 | 待完善 |
| bookingService.js | 预订服务 | 待完善 |
| reviewService.js | 评价服务 | 待完善 |
| commentService.js | 评论服务 | 待完善 |
| messageService.js | 消息服务 | 待完善 |
| themeService.js | 主题服务 | 已完成 |
| auth.js | 认证服务 | 已完成 |
| http.js | HTTP拦截器 | 已完成 |

### 2.3 后端API状态

| 接口 | 路径 | 状态 |
|------|------|------|
| 微信登录 | POST /api/auth/login | ✅ 已完成 |
| Token刷新 | POST /api/auth/refresh | ✅ 已完成 |
| 健康检查 | GET /api/health | ✅ 已完成 |
| 房源管理 | /api/houses/* | ❌ 待开发 |
| 用户管理 | /api/users/* | ❌ 待开发 |
| 预订管理 | /api/bookings/* | ❌ 待开发 |

---

## 三、分阶段开发计划

### 第一阶段：功能完善（1-2周）

**目标：确保所有页面功能可用**

#### 3.1.1 补全缺失页面

```
待创建/完善页面：
├── pages/home/search/          # 房源搜索页
│   ├── search.js
│   ├── search.json
│   ├── search.wxml
│   └── search.wxss
├── pages/square/search/        # 帖子搜索页（检查完整性）
└── 各页面的 .json 配置文件
```

#### 3.1.2 完善核心功能

| 功能模块 | 当前状态 | 需要完成 | 优先级 |
|----------|----------|----------|--------|
| 房源详情 | 基础展示 | 预订按钮、收藏功能、联系房东 | P0 |
| 房源发布 | 表单完成 | 图片上传、地图选点、预览 | P1 |
| 帖子详情 | 基础展示 | 评论列表、点赞动画、分享 | P0 |
| 帖子发布 | 表单完成 | 图片上传、标签选择、草稿 | P1 |
| 用户资料 | 基础展示 | 头像上传、身份认证、背景图 | P1 |
| 预订流程 | 页面存在 | 支付对接、订单状态 | P2 |

#### 3.1.3 数据流打通

```javascript
// 当前状态：各页面独立使用模拟数据
// 目标状态：统一数据层，支持真实数据

// 实施步骤：
// 1. 完善 services/apiProxy.js 作为统一数据入口
// 2. 添加数据缓存机制（减少网络请求）
// 3. 实现数据同步逻辑（本地+远程）
// 4. 添加错误处理和降级策略
```

---

### 第二阶段：云开发集成（1周）

**目标：启用云数据库，替换模拟数据**

#### 3.2.1 创建数据库集合

在云开发控制台创建以下集合：

| 集合名 | 用途 | 字段数 | 索引 |
|--------|------|--------|------|
| houses | 房源数据 | 15+ | location, createTime, host.id |
| posts | 帖子数据 | 12+ | type, createTime, author.id |
| users | 用户数据 | 10+ | openid, role |
| reviews | 评价数据 | 8+ | houseId, userId |
| favorites | 收藏数据 | 5+ | userId, targetId |
| bookings | 预订数据 | 10+ | userId, houseId, status |
| messages | 消息数据 | 6+ | fromId, toId |

#### 3.2.2 数据库字段设计

**houses 集合：**
```json
{
  "_id": "自动生成",
  "title": "房源标题",
  "location": "详细地址",
  "price": 100,
  "unit": "天",
  "image": "封面图URL",
  "images": ["图片数组"],
  "tags": ["海景", "WiFi"],
  "facilities": ["WiFi", "厨房", "空调"],
  "description": "房源描述",
  "rating": 4.8,
  "likes": 0,
  "viewCount": 0,
  "host": {
    "id": "房东用户ID",
    "name": "房东名称",
    "avatar": "头像URL",
    "phone": "联系电话"
  },
  "latitude": 18.2529,
  "longitude": 109.5120,
  "status": "active",
  "createTime": "服务器时间",
  "updateTime": "服务器时间"
}
```

**posts 集合：**
```json
{
  "_id": "自动生成",
  "title": "帖子标题",
  "content": "帖子内容",
  "type": "活动|找搭子|技能变现|讨论",
  "author": {
    "id": "用户ID",
    "name": "用户名",
    "avatar": "头像URL"
  },
  "images": ["图片数组"],
  "tags": ["标签"],
  "likes": 0,
  "comments": 0,
  "views": 0,
  "collects": 0,
  "status": "active",
  "createTime": "服务器时间"
}
```

**users 集合：**
```json
{
  "_id": "自动生成",
  "openid": "微信openid",
  "nickname": "昵称",
  "avatar": "头像URL",
  "role": "villager|traveler",
  "identity": "villager|traveler",
  "phone": "手机号",
  "signature": "个性签名",
  "background": "背景图URL",
  "stats": {
    "posts": 0,
    "followers": 0,
    "following": 0
  },
  "createTime": "服务器时间",
  "updateTime": "服务器时间"
}
```

#### 3.2.3 关闭模拟模式

```javascript
// services/houseService.js
const USE_MOCK = false  // 改为 false

// services/postService.js  
const USE_MOCK = false  // 改为 false
```

#### 3.2.4 云存储目录结构

```
云存储目录：
├── houses/           # 房源图片
│   ├── {houseId}/
│   │   ├── cover.jpg
│   │   └── images/
│   │       ├── 1.jpg
│   │       └── 2.jpg
├── posts/            # 帖子图片
│   └── {postId}/
│       ├── 1.jpg
│       └── 2.jpg
├── users/            # 用户头像和背景
│   └── {userId}/
│       ├── avatar.jpg
│       └── background.jpg
└── temp/             # 临时文件（定期清理）
```

---

### 第三阶段：自建后端部署（1-2周）

**目标：用户认证和敏感数据使用自建后端**

#### 3.3.1 完善后端接口

```
backend/src/routes/
├── auth.js           # ✅ 已完成 - 登录认证
├── houses.js         # ❌ 待开发 - 房源CRUD
├── bookings.js       # ❌ 待开发 - 预订管理
├── users.js          # ❌ 待开发 - 用户管理
├── admin.js          # ❌ 待开发 - 管理后台
└── upload.js         # ❌ 待开发 - 文件上传
```

#### 3.3.2 数据库扩展

```sql
-- 扩展 database.sql

-- 房源表
CREATE TABLE IF NOT EXISTS `houses` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL,
  `title` VARCHAR(255) NOT NULL,
  `location` VARCHAR(500),
  `price` DECIMAL(10,2),
  `unit` VARCHAR(20) DEFAULT '天',
  `description` TEXT,
  `facilities` JSON,
  `latitude` DECIMAL(10,6),
  `longitude` DECIMAL(10,6),
  `status` ENUM('active', 'inactive', 'pending') DEFAULT 'pending',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 预订表
CREATE TABLE IF NOT EXISTS `bookings` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `house_id` INT NOT NULL,
  `user_id` INT NOT NULL,
  `check_in` DATE,
  `check_out` DATE,
  `total_price` DECIMAL(10,2),
  `status` ENUM('pending', 'paid', 'confirmed', 'completed', 'cancelled') DEFAULT 'pending',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`house_id`) REFERENCES `houses`(`id`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 评价表
CREATE TABLE IF NOT EXISTS `reviews` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `house_id` INT NOT NULL,
  `user_id` INT NOT NULL,
  `rating` INT CHECK (rating >= 1 AND rating <= 5),
  `content` TEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`house_id`) REFERENCES `houses`(`id`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 3.3.3 部署配置清单

| 配置项 | 说明 | 推荐方案 |
|--------|------|----------|
| 云服务器 | 运行Node.js后端 | 阿里云/腾讯云轻量服务器 |
| 域名 | 小程序要求HTTPS | 备案域名 + SSL证书 |
| 进程管理 | 保持服务稳定 | PM2 |
| 反向代理 | 处理HTTPS | Nginx |
| 数据库 | 存储用户数据 | MySQL 8.0 |

#### 3.3.4 部署步骤

```bash
# 1. 服务器环境准备
sudo apt update
sudo apt install nodejs npm nginx mysql-server

# 2. 安装 PM2
sudo npm install -g pm2

# 3. 克隆代码
git clone [项目地址]
cd backend
npm install

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 填写数据库配置和微信AppID

# 5. 初始化数据库
mysql -u root -p < database.sql

# 6. 启动服务
pm2 start src/app.js --name "travel-api"

# 7. 配置 Nginx
# /etc/nginx/sites-available/travel-api
server {
    listen 443 ssl;
    server_name api.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

### 第四阶段：混合架构整合（1周）

**目标：实现 HTTP 后端 + 云开发混合架构**

#### 3.4.1 认证流程设计

```
完整登录流程：

┌─────────────┐                    ┌─────────────┐
│  小程序前端  │                    │  自建后端   │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  1. wx.login() 获取 code         │
       ├─────────────────────────────────→│
       │                                  │
       │  2. 调用微信API换取 openid       │
       │                          ├───────┤
       │                          │       │
       │  3. 查询/创建用户        │       │
       │                          ├───────┤
       │                          │       │
       │  4. 生成 JWT Token       │       │
       │←─────────────────────────┤       │
       │  { accessToken, refreshToken }   │
       │                                  │
       │  5. 保存 Token 到本地            │
       ├─────────────────────────────────→│
       │                                  │
       │  6. 使用 Token 访问云开发        │
       │──────────────────────────────────→│
       │                          ┌───────┴───────┐
       │                          │   云开发       │
       │                          │   业务数据     │
       │                          └───────────────┘
```

#### 3.4.2 数据分层策略

| 数据类型 | 存储位置 | 原因 |
|----------|----------|------|
| 用户账号信息 | MySQL | 敏感数据，安全可控 |
| 认证Token | MySQL | 需要撤销和管理 |
| 房源数据 | 云开发 | 非敏感，需要CDN |
| 帖子数据 | 云开发 | 非敏感，实时同步 |
| 预订记录 | MySQL | 涉及金钱，需要事务 |
| 评价数据 | 云开发 | 非敏感，高并发读 |
| 消息数据 | 云开发 | 实时推送需求 |

#### 3.4.3 服务层整合

```javascript
// services/apiProxy.js - 统一数据入口

class ApiProxy {
  constructor() {
    this.authSource = null  // 'http' | 'cloud'
  }
  
  // 认证相关 - 走HTTP后端
  async login(code, userInfo) {
    return await httpService.login(code, userInfo)
  }
  
  async refreshToken(refreshToken) {
    return await httpService.refreshToken(refreshToken)
  }
  
  // 业务数据 - 走云开发
  async getHouses(filter) {
    return await cloudService.getHouses(filter)
  }
  
  async getPosts(filter) {
    return await cloudService.getPosts(filter)
  }
  
  // 预订相关 - 走HTTP后端
  async createBooking(bookingData) {
    return await httpService.createBooking(bookingData)
  }
}
```

---

### 第五阶段：功能增强（持续迭代）

#### 3.5.1 即时通讯

```
使用云开发实时数据推送

功能：
├── 聊天消息实时同步
├── 系统通知推送
├── 在线状态显示
└── 消息已读回执

技术方案：
├── 云开发数据库监听
├── WebSocket 长连接
└── 消息队列缓冲
```

#### 3.5.2 支付功能

```
微信支付集成

功能：
├── 房源预订支付
├── 押金管理
├── 退款流程
└── 账单记录

技术方案：
├── 微信支付API
├── 支付回调处理
└── 订单状态机
```

#### 3.5.3 数据分析

```
管理后台增强

功能：
├── 用户数据分析
│   ├── 用户增长趋势
│   ├── 活跃度统计
│   └── 用户画像
├── 房源热度统计
│   ├── 浏览量排行
│   ├── 预订量排行
│   └── 收藏量排行
├── 收入报表
│   ├── 日/周/月收入
│   ├── 房东收益
│   └── 平台抽成
└── 运营看板
    ├── 关键指标
    ├── 异常预警
    └── 数据导出
```

---

## 四、任务清单

### 4.1 本周任务（优先级P0）

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 1 | 创建首页搜索页面 | 2h | - | 待开始 |
| 2 | 完善房源详情页功能 | 3h | - | 待开始 |
| 3 | 完善帖子详情页功能 | 2h | - | 待开始 |
| 4 | 修复已知Bug | 2h | - | 待开始 |

### 4.2 下周任务（优先级P1）

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 5 | 创建云数据库集合 | 1h | - | 待开始 |
| 6 | 迁移模拟数据到云数据库 | 2h | - | 待开始 |
| 7 | 实现图片上传功能 | 3h | - | 待开始 |
| 8 | 完善用户资料页 | 2h | - | 待开始 |

### 4.3 后续任务（优先级P2）

| 序号 | 任务 | 预计时间 | 负责人 | 状态 |
|------|------|----------|--------|------|
| 9 | 完善后端房源接口 | 4h | - | 待开始 |
| 10 | 完善后端预订接口 | 4h | - | 待开始 |
| 11 | 部署测试环境 | 4h | - | 待开始 |
| 12 | 配置域名和HTTPS | 2h | - | 待开始 |

---

## 五、风险评估

### 5.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 云开发配额不足 | 服务中断 | 中 | 监控用量，及时升级 |
| 后端服务不稳定 | 用户无法登录 | 低 | PM2进程守护，自动重启 |
| 数据库性能瓶颈 | 响应变慢 | 中 | 添加索引，读写分离 |
| 微信API变更 | 登录失败 | 低 | 关注官方公告，及时适配 |

### 5.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 用户量增长过快 | 成本超支 | 中 | 弹性扩容，成本监控 |
| 内容审核不及时 | 合规风险 | 中 | 建立审核机制，AI辅助 |
| 房东/租客纠纷 | 平台责任 | 中 | 明确服务条款，建立投诉机制 |

---

## 六、成本预估

### 6.1 月度成本（月活1000用户）

| 项目 | 云开发 | 自建后端 | 混合架构 |
|------|--------|----------|----------|
| 云服务器 | - | ¥50-100 | ¥30-50 |
| 云开发 | ¥50-100 | - | ¥20-50 |
| 域名+SSL | - | ¥10 | ¥10 |
| 数据库 | 包含 | ¥20-50 | 包含 |
| CDN流量 | 包含 | ¥10-30 | 包含 |
| **合计** | **¥50-100** | **¥90-190** | **¥60-110** |

### 6.2 开发成本

| 阶段 | 工作量 | 建议周期 |
|------|--------|----------|
| 第一阶段 | 40-60人时 | 1-2周 |
| 第二阶段 | 20-30人时 | 1周 |
| 第三阶段 | 40-60人时 | 1-2周 |
| 第四阶段 | 20-30人时 | 1周 |
| **合计** | **120-180人时** | **4-6周** |

---

## 七、附录

### 7.1 项目目录结构

```
旅居服务站/
├── app.js                    # 应用入口
├── app.json                  # 应用配置
├── app.wxss                  # 全局样式
├── pages/                    # 页面目录
│   ├── home/                 # 首页模块
│   │   ├── index/            # 首页
│   │   └── search/           # 搜索页
│   ├── house/                # 房源模块
│   │   ├── detail/           # 房源详情
│   │   ├── publish/          # 发布房源
│   │   ├── booking/          # 预订页面
│   │   ├── listing/          # 房源列表
│   │   └── map-picker/       # 地图选点
│   ├── square/               # 广场模块
│   │   ├── index/            # 广场首页
│   │   ├── detail/           # 帖子详情
│   │   ├── search/           # 搜索页
│   │   ├── publish/          # 发布帖子
│   │   ├── reviews/          # 评价列表
│   │   └── write-review/     # 写评价
│   ├── user/                 # 用户中心
│   │   ├── profile/          # 个人主页
│   │   ├── edit-profile/     # 编辑资料
│   │   ├── orders/           # 我的订单
│   │   ├── publish-list/     # 我的发布
│   │   ├── history/          # 浏览历史
│   │   ├── support/          # 服务支持
│   │   ├── settings/         # 设置
│   │   └── message/          # 消息
│   ├── auth/                 # 登录认证
│   │   ├── login/            # 登录页
│   │   └── identity/         # 身份选择
│   ├── admin/                # 管理后台
│   │   ├── index/            # 后台首页
│   │   ├── users/            # 用户管理
│   │   ├── audit/            # 内容审核
│   │   └── stats/            # 数据统计
│   └── common/               # 公共页面
│       └── report-success/   # 举报成功
├── components/               # 组件目录
│   ├── post-card/            # 帖子卡片
│   ├── identity-badge/       # 身份徽章
│   └── comment-modal/        # 评论弹窗
├── services/                 # 服务层
│   ├── houseService.js       # 房源服务
│   ├── postService.js        # 帖子服务
│   ├── userService.js        # 用户服务
│   ├── auth.js               # 认证服务
│   ├── http.js               # HTTP拦截器
│   └── ...                   # 其他服务
├── models/                   # 数据模型
│   └── authModel.js          # 认证模型
├── utils/                    # 工具函数
│   ├── cloud.js              # 云开发工具
│   ├── navigation.js         # 导航工具
│   └── auth.js               # 认证工具
├── config/                   # 配置文件
│   ├── routes.js             # 路由配置
│   ├── houses.js             # 房源配置
│   └── posts.js              # 帖子配置
├── images/                   # 图片资源
│   ├── tabbar/               # TabBar图标
│   └── icons/                # 其他图标
├── backend/                  # 后端代码
│   ├── src/
│   │   ├── app.js            # Express入口
│   │   ├── routes/           # 路由
│   │   ├── controllers/      # 控制器
│   │   └── config/           # 配置
│   └── database.sql          # 数据库脚本
└── docs/                     # 文档目录
    └── 开发计划.md            # 本文档
```

### 7.2 关键配置文件

| 文件 | 用途 |
|------|------|
| app.json | 小程序页面和TabBar配置 |
| app.js | 云开发初始化、全局数据 |
| config/routes.js | 路由路径常量 |
| services/http.js | HTTP请求拦截器 |
| models/authModel.js | 统一认证模型 |
| backend/.env | 后端环境变量 |

### 7.3 联系方式

- 项目仓库：[GitHub地址]
- 问题反馈：[Issues地址]
- 技术支持：[联系方式]

---

> 文档维护：请随着项目进展及时更新本文档
