# 云开发设计方案

**项目名称**: 旅居服务站
**文档版本**: v1.0
**创建日期**: 2026-03-01

---

## 一、设计目标

基于双通道弹性架构，云开发负责**简单CRUD操作**和**内容存储**，与自建后端形成互补。

---

## 二、职责划分

### 2.1 自建后端（已完成）

| 功能 | 原因 |
|------|------|
| 认证（登录/Token） | 敏感数据，JWT管理 |
| 用户信息管理 | 需要认证，敏感数据 |
| 订单管理 | 涉及支付，复杂状态流转 |
| 消息通知 | 需要复杂查询 |
| 统计报表 | 复杂聚合查询 |

### 2.2 云开发（待实现）

| 功能 | 原因 |
|------|------|
| 民宿发布/列表 | 简单CRUD |
| 技能发布/列表 | 简单CRUD |
| 广场帖子发布/列表 | 简单CRUD |
| 评论/点赞/收藏 | 简单CRUD |
| 关注/粉丝 | 简单CRUD |
| 浏览历史 | 简单存储 |

---

## 三、云数据库集合设计

### 3.1 集合列表

| 集合名 | 说明 | 主键 | 索引 |
|--------|------|------|------|
| `houses` | 民宿房源 | _id | _openid, status, createTime |
| `posts` | 广场帖子 | _id | _openid, status, createTime |
| `skills` | 技能资源 | _id | _openid, type, status |
| `comments` | 评论 | _id | itemId, _openid |
| `likes` | 点赞 | _id | itemId, _openid |
| `favorites` | 收藏 | _id | itemId, _openid |
| `follows` | 关注 | _id | followerId, followingId |
| `history` | 浏览历史 | _id | _openid, itemId |
| `drafts` | 草稿箱 | _id | _openid, type |

### 3.2 集合字段设计

#### 3.2.1 houses（民宿房源）

```json
{
  "_id": "唯一标识",
  "_openid": "发布者openid",
  "title": "房源标题",
  "description": "详细描述",
  "images": ["图片URL数组"],
  "coverImage": "封面图片",
  "price": 298,
  "unit": "元/晚",
  "location": "位置描述",
  "latitude": 30.123456,
  "longitude": 120.123456,
  "houseInfo": {
    "bedroom": 2,
    "bathroom": 1,
    "capacity": 4,
    "facilities": ["wifi", "空调", "厨房"]
  },
  "contact": {
    "phone": "13800138000",
    "wechat": "wx123456"
  },
  "viewCount": 0,
  "likeCount": 0,
  "favoriteCount": 0,
  "status": "active",
  "createTime": "2026-03-01T00:00:00.000Z",
  "updateTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.2 posts（广场帖子）

```json
{
  "_id": "唯一标识",
  "_openid": "发布者openid",
  "title": "帖子标题",
  "content": "帖子内容",
  "images": ["图片URL数组"],
  "category": "分类",
  "tags": ["标签数组"],
  "viewCount": 0,
  "likeCount": 0,
  "commentCount": 0,
  "status": "active",
  "isTop": false,
  "createTime": "2026-03-01T00:00:00.000Z",
  "updateTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.3 skills（技能资源）

```json
{
  "_id": "唯一标识",
  "_openid": "发布者openid",
  "type": "task|video|resource",
  "title": "标题",
  "description": "描述",
  "images": ["图片数组"],
  "price": 100,
  "unit": "元/次",
  "skillInfo": {
    "category": "技能分类",
    "experience": "3年",
    "certificate": "证书信息"
  },
  "viewCount": 0,
  "likeCount": 0,
  "status": "active",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.4 comments（评论）

```json
{
  "_id": "唯一标识",
  "_openid": "评论者openid",
  "itemId": "关联物品ID",
  "itemType": "house|post|skill",
  "content": "评论内容",
  "parentId": "父评论ID（可选）",
  "replyToId": "回复用户ID（可选）",
  "likeCount": 0,
  "status": "active",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.5 likes（点赞）

```json
{
  "_id": "唯一标识",
  "_openid": "点赞者openid",
  "itemId": "物品ID",
  "itemType": "house|post|skill|comment",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.6 favorites（收藏）

```json
{
  "_id": "唯一标识",
  "_openid": "收藏者openid",
  "itemId": "物品ID",
  "itemType": "house|post|skill",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.7 follows（关注）

```json
{
  "_id": "唯一标识",
  "followerId": "关注者用户ID",
  "followingId": "被关注者用户ID",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

#### 3.2.8 history（浏览历史）

```json
{
  "_id": "唯一标识",
  "_openid": "用户openid",
  "itemId": "物品ID",
  "itemType": "house|post|skill",
  "itemTitle": "物品标题",
  "itemImage": "物品图片",
  "createTime": "2026-03-01T00:00:00.000Z"
}
```

---

## 四、服务层实现

### 4.1 现有服务文件

| 文件 | 功能 | 状态 |
|------|------|------|
| `services/houseService.js` | 民宿服务 | 已存在 |
| `services/postService.js` | 帖子服务 | 已存在 |
| `services/commentService.js` | 评论服务 | 已存在 |
| `services/reviewService.js` | 评价服务 | 已存在 |
| `services/draftService.js` | 草稿服务 | 已存在 |

### 4.2 需要补充的服务

| 文件 | 功能 | 优先级 |
|------|------|--------|
| `services/likeService.js` | 点赞服务 | 高 |
| `services/favoriteService.js` | 收藏服务 | 高 |
| `services/followService.js` | 关注服务 | 高 |
| `services/skillService.js` | 技能服务 | 中 |
| `services/historyService.js` | 历史服务 | 中 |

---

## 五、API设计

### 5.1 民宿模块

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/houses` | 获取房源列表 |
| GET | `/houses/:id` | 获取房源详情 |
| POST | `/houses` | 发布房源 |
| PUT | `/houses/:id` | 更新房源 |
| DELETE | `/houses/:id` | 删除房源 |

### 5.2 广场模块

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/posts` | 获取帖子列表 |
| GET | `/posts/:id` | 获取帖子详情 |
| POST | `/posts` | 发布帖子 |
| PUT | `/posts/:id` | 更新帖子 |
| DELETE | `/posts/:id` | 删除帖子 |

### 5.3 互动模块

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/like` | 点赞 |
| DELETE | `/like` | 取消点赞 |
| POST | `/favorite` | 收藏 |
| DELETE | `/favorite` | 取消收藏 |
| POST | `/follow` | 关注 |
| DELETE | `/follow` | 取消关注 |
| POST | `/comment` | 发表评论 |
| GET | `/comments/:itemId` | 获取评论列表 |

---

## 六、评估报告

### 6.1 与原计划对比

| 原计划 | 当前设计 | 评估 |
|--------|----------|------|
| 双通道架构 | 保持一致 | 符合 |
| 云开发负责简单CRUD | 集合设计明确 | 符合 |
| 自建后端负责复杂查询 | 已完成开发 | 符合 |
| apiProxy统一代理 | 已存在 | 符合 |

### 6.2 稳定性评估

| 维度 | 评分 | 说明 |
|------|------|------|
| **数据安全** | 4/5 | 敏感数据在自建后端 |
| **性能** | 4/5 | 云开发有免费额度 |
| **可用性** | 5/5 | 双通道降级机制 |
| **可维护性** | 4/5 | 服务层分离清晰 |
| **扩展性** | 4/5 | 可随时迁移到自建后端 |

### 6.3 风险分析

| 风险 | 级别 | 应对措施 |
|------|------|----------|
| 云开发额度限制 | 低 | 监控用量，超标迁移 |
| 集合不存在错误 | 中 | 本地存储降级 |
| openid获取失败 | 低 | 登录态检查 |

### 6.4 结论

**评估结果**: 设计合理，可以执行

**理由**:
1. 符合双通道架构设计原则
2. 职责划分清晰
3. 有降级机制保障可用性
4. 与现有代码兼容

---

## 七、实施计划

### 7.1 第一阶段：集合创建

1. 在微信开发者工具中创建9个集合
2. 添加必要的索引

### 7.2 第二阶段：服务完善

1. 补充5个缺失的服务文件
2. 统一错误处理

### 7.3 第三阶段：测试验证

1. 发布/列表功能测试
2. 互动功能测试
3. 降级机制测试

---

**文档版本**: v1.0
**状态**: 待执行