# ç™»å½•æ³¨å†ŒåŠŸèƒ½è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.3.0 è§„åˆ’  
> **çŠ¶æ€**: ğŸ”„ è®¾è®¡å®Œæˆï¼Œå¾…å¼€å‘  
> **å·¥æœŸä¼°è®¡**: 6-10 å°æ—¶ï¼ˆå‰ç«¯å¼€å‘ï¼‰  
> **ä¼˜å…ˆçº§**: ğŸ”´ P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [ç”¨æˆ·æµç¨‹](#ç”¨æˆ·æµç¨‹)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
5. [åç«¯æ¥å£](#åç«¯æ¥å£)
6. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
7. [å®‰å…¨ç­–ç•¥](#å®‰å…¨ç­–ç•¥)
8. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
9. [æµ‹è¯•æ¸…å•](#æµ‹è¯•æ¸…å•)
10. [å¼€å‘æ­¥éª¤](#å¼€å‘æ­¥éª¤)

---

## åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **å¾®ä¿¡æˆæƒç™»å½•** | ä¸€é”®ç™»å½•ï¼Œè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ | ğŸ”´ P0 |
| **æ‰‹æœºå·ç™»å½•** | è¿è¥å•†æ‰‹æœºå·å¿«é€Ÿç™»å½• | ğŸŸ¡ P1 |
| **æ¸¸å®¢æ¨¡å¼** | åŒ¿åæµè§ˆï¼Œæ”¯æŒéƒ¨åˆ†åŠŸèƒ½ | ğŸŸ¡ P1 |
| **èº«ä»½æ³¨å†Œ** | æ‘æ°‘/æ¸¸æ°‘èº«ä»½é€‰æ‹© | ğŸ”´ P0 |
| **å¯†ç é‡ç½®** | å¿˜è®°å¯†ç é‡ç½®æµç¨‹ | ğŸŸ¡ P1 |
| **ç™»å‡º** | æ¸…ç©ºè®¤è¯çŠ¶æ€ï¼Œè¿”å›ç™»å½•é¡µ | ğŸ”´ P0 |

### æ”¯æŒçš„ç™»å½•æ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç™»å½•é€‰æ‹©é¡µé¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚          â”‚
    â–¼      â–¼      â–¼          â–¼
 å¾®ä¿¡ç™»å½• æ‰‹æœºç™»å½• æ¸¸å®¢æ¨¡å¼ èº«ä»½æ³¨å†Œ
    â”‚      â”‚      â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   é¦–é¡µ      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç”¨æˆ·æµç¨‹

### 1. é¦–æ¬¡ç”¨æˆ·æµç¨‹

```
åº”ç”¨å¯åŠ¨ (onLaunch)
    â†“
æ£€æŸ¥æœ¬åœ° token
    â†“
token å­˜åœ¨ä¸”æœ‰æ•ˆï¼Ÿ
    â”œâ”€ YES â†’ è·³è¿‡ç™»å½•ï¼Œè¿›å…¥é¦–é¡µ
    â””â”€ NO  â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ
    â†“
ç”¨æˆ·é€‰æ‹©ç™»å½•æ–¹å¼
    â”œâ”€ å¾®ä¿¡ç™»å½• â†’ wx.login() â†’ è·å– code
    â”œâ”€ æ‰‹æœºç™»å½• â†’ wx.getPhoneNumber() â†’ è·å–æ‰‹æœºå·
    â””â”€ æ¸¸å®¢æ¨¡å¼ â†’ æœ¬åœ°æ ‡è®° isGuest
    â†“
å‰ç«¯å‘é€ code/æ‰‹æœºå· åˆ°åç«¯
    â†“
åç«¯éªŒè¯ â†’ è¿”å› token + userInfo
    â†“
å‰ç«¯ä¿å­˜ token å’Œ userInfo
    â†“
é‡å®šå‘åˆ°èº«ä»½é€‰æ‹©é¡µé¢ï¼ˆé¦–æ¬¡ç”¨æˆ·ï¼‰
    â†“
ç”¨æˆ·é€‰æ‹©èº«ä»½ â†’ æ‘æ°‘/æ¸¸æ°‘
    â†“
å‘é€èº«ä»½ä¿¡æ¯åˆ°åç«¯
    â†“
é‡å®šå‘åˆ°é¦–é¡µ âœ“
```

### 2. å·²ç™»å½•ç”¨æˆ·æµç¨‹

```
åº”ç”¨å¯åŠ¨ (onLaunch)
    â†“
æ£€æŸ¥æœ¬åœ° token
    â†“
token æœ‰æ•ˆ
    â”œâ”€ YES â†’ å‰ç«¯åŠ è½½ userInfo
    â””â”€ NO  â†’ è°ƒç”¨ /api/auth/refresh åˆ·æ–°
    â†“
éªŒè¯æˆåŠŸ â†’ è¿›å…¥é¦–é¡µ
éªŒè¯å¤±è´¥ â†’ æ¸…ç©ºæœ¬åœ°çŠ¶æ€ï¼Œé‡å®šå‘ç™»å½•é¡µ
```

### 3. ç™»å‡ºæµç¨‹

```
ç”¨æˆ·ç‚¹å‡»è®¾ç½® â†’ ç™»å‡ºæŒ‰é’®
    â†“
è°ƒç”¨ /api/auth/logout
    â†“
åç«¯æ¸…ç©º session
    â†“
å‰ç«¯æ¸…ç©º token + userInfo + isGuest
    â†“
é‡å®šå‘åˆ°ç™»å½•é¡µ âœ“
```

---

## æŠ€æœ¯æ¶æ„

### ğŸ”´ æ ¸å¿ƒé—®é¢˜ï¼šToken ä½“ç³»éœ€å®Œæ•´å‡çº§

**å½“å‰é—®é¢˜**ï¼šåªæœ‰å•ä¸€ tokenï¼Œåˆ·æ–°æ—¶ç”¨åŒä¸€ä¸ª tokenï¼Œå®‰å…¨é£é™©å¤§ã€‚

**æ¨èæ–¹æ¡ˆ**ï¼šåŒ Token æ¨¡å¼ï¼ˆä¸šç•Œæ ‡å‡†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åŒ Token è®¤è¯ç³»ç»Ÿ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘           â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Access Token         â”‚  çŸ­æœŸï¼ˆ1~2å°æ—¶ï¼‰
    â”‚  Refresh Token        â”‚  é•¿æœŸï¼ˆ7å¤©ï¼‰
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  HTTP æ‹¦æˆªå™¨          â”‚
    â”‚  - token è‡ªåŠ¨æ³¨å…¥      â”‚
    â”‚  - åˆ·æ–°é˜Ÿåˆ—é”æœºåˆ¶      â”‚  â­ é˜²æ­¢å¹¶å‘401
    â”‚  - å¤±è´¥è‡ªåŠ¨é‡è¯•        â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æœ¬åœ°å­˜å‚¨              â”‚
    â”‚  - accessToken        â”‚
    â”‚  - refreshToken       â”‚
    â”‚  - expiresIn          â”‚
    â”‚  - userInfo           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç™»å½•è®¤è¯ç³»ç»Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘           â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å‰ç«¯    â”‚  â”‚ åç«¯   â”‚
    â”‚ å°ç¨‹åº  â”‚  â”‚ API    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  HTTP æ‹¦æˆªå™¨             â”‚
    â”‚  (åŒtokenç®¡ç†+åˆ·æ–°é˜Ÿåˆ—)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æœ¬åœ°å­˜å‚¨              â”‚
    â”‚  (accessToken/        â”‚
    â”‚   refreshToken/       â”‚
    â”‚   userInfo)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯æ¨¡å—ç»“æ„

```
pages/login/                   â† ç™»å½•ç›¸å…³é¡µé¢
â”œâ”€â”€ index/                     â† ç™»å½•é€‰æ‹©é¡µ
â”‚   â”œâ”€â”€ index.wxml
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ index.wxss
â”‚   â””â”€â”€ index.json
â”œâ”€â”€ identity/                  â† èº«ä»½é€‰æ‹©é¡µï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ index.wxml
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ index.wxss
â”‚   â””â”€â”€ index.json
â””â”€â”€ password-reset/            â† å¯†ç é‡ç½®é¡µï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€ index.wxml
    â”œâ”€â”€ index.js
    â”œâ”€â”€ index.wxss
    â””â”€â”€ index.json

services/
â”œâ”€â”€ auth.ts                    â† ğŸ¯ è®¤è¯æœåŠ¡é›†ä¸­ç®¡ç†
â”‚                              â† ç»Ÿä¸€ï¼šlogin/logout/refresh/verify
â”œâ”€â”€ http.ts                    â† HTTP æ‹¦æˆªå™¨ + åˆ·æ–°é˜Ÿåˆ—æœºåˆ¶
â””â”€â”€ api.config.ts              â† API é…ç½®

stores/                        â† å…¨å±€çŠ¶æ€
â””â”€â”€ auth.ts                    â† è®¤è¯çŠ¶æ€ï¼ˆaccessToken/refreshTokenï¼‰

types/
â””â”€â”€ auth.ts                    â† AuthTokens ç±»å‹å®šä¹‰
```

---

## å‰ç«¯å®ç°

### 1. ç™»å½•é¡µé¢ï¼ˆpages/login/indexï¼‰

#### WXML ç»“æ„

```xml
<!-- ç™»å½•é€‰æ‹©é¡µé¢ -->
<view class="page {{theme === 'dark' ? 'dark-mode' : ''}} {{appVersion === 'elderly' ? 'elderly-mode' : ''}}">
  <!-- å“ç‰Œå±•ç¤º -->
  <view class="logo-section">
    <text class="logo">ğŸ </text>
    <text class="app-name">æ—…å±…æœåŠ¡ç«™</text>
    <text class="slogan">æ‘æ°‘ä¸æ¸¸æ°‘çš„ç¤¾äº¤æœåŠ¡å¹³å°</text>
  </view>

  <!-- ç™»å½•æ–¹å¼é€‰æ‹© -->
  <view class="login-methods">
    <!-- å¾®ä¿¡ç™»å½• -->
    <button 
      class="login-btn wechat-btn"
      open-type="getPhoneNumber"
      bindgetphonenumber="loginWithWeChat"
    >
      å¾®ä¿¡ä¸€é”®ç™»å½•
    </button>

    <!-- æ‰‹æœºå·ç™»å½• -->
    <button 
      class="login-btn phone-btn"
      open-type="getPhoneNumber"
      bindgetphonenumber="loginWithPhone"
    >
      æ‰‹æœºå·å¿«é€Ÿç™»å½•
    </button>

    <!-- æ¸¸å®¢æ¨¡å¼ -->
    <button 
      class="login-btn guest-btn"
      bindtap="loginAsGuest"
    >
      æ¸¸å®¢æ¨¡å¼ï¼ˆä»…æµè§ˆï¼‰
    </button>
  </view>

  <!-- ç”¨æˆ·åè®® -->
  <view class="agreement">
    <view class="text">
      <text>ç™»å½•å³ä»£è¡¨åŒæ„</text>
      <text class="link">ã€Šç”¨æˆ·æœåŠ¡åè®®ã€‹</text>
      <text>å’Œ</text>
      <text class="link">ã€Šéšç§ä¿æŠ¤æ”¿ç­–ã€‹</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{isLoading}}">
    <view class="spinner"></view>
    <text>ç™»å½•ä¸­...</text>
  </view>
</view>
```

#### JavaScript é€»è¾‘

```javascript
// pages/login/index.js
const auth = require('../../services/auth')  // â­ ä½¿ç”¨ç»Ÿä¸€è®¤è¯æœåŠ¡
const app = getApp()

Page({
  data: {
    theme: 'light',
    appVersion: 'standard',
    isLoading: false
  },

  onLoad() {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    const accessToken = wx.getStorageSync('accessToken')
    if (accessToken) {
      // å·²ç™»å½•ï¼Œç›´æ¥è·³è½¬é¦–é¡µ
      wx.redirectTo({ url: '/pages/index/index' })
    }

    // åŒæ­¥ä¸»é¢˜å’Œç‰ˆæœ¬
    this.setData({
      theme: app.globalData.theme,
      appVersion: app.globalData.appVersion
    })
  },

  onShow() {
    // æ¯æ¬¡æ˜¾ç¤ºæ—¶åŒæ­¥ä¸»é¢˜
    this.setData({
      theme: app.globalData.theme,
      appVersion: app.globalData.appVersion
    })
  },

  // å¾®ä¿¡ç™»å½• â­ ä½¿ç”¨æ ‡å‡†å¾®ä¿¡ç™»å½•æµç¨‹
  async loginWithWeChat() {
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (this.data.isLoading) return
    
    try {
      this.setData({ isLoading: true })

      // 1. è·å–ç™»å½•ç ï¼ˆæ ‡å‡†æµç¨‹ï¼‰
      const { code } = await wx.login()
      
      // 2. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°æ¥å£ wx.getUserProfileï¼‰
      const userProfile = await wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™'
      })
      
      // 3. è°ƒç”¨è®¤è¯æœåŠ¡ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
      const result = await auth.loginWithWeChat(code, userProfile.userInfo)

      // 4. æ£€æŸ¥èº«ä»½æ˜¯å¦å·²é€‰æ‹©
      if (!result.userInfo.identity) {
        // é¦–æ¬¡ç”¨æˆ·ï¼Œè¿›å…¥èº«ä»½é€‰æ‹©é¡µé¢
        wx.navigateTo({
          url: '/pages/login/identity/index'
        })
      } else {
        // å·²æœ‰èº«ä»½ï¼Œç›´æ¥è¿›å…¥é¦–é¡µ
        wx.redirectTo({
          url: '/pages/index/index'
        })
      }
      
      // åŸ‹ç‚¹ç»Ÿè®¡
      this.trackLoginSuccess('wechat')
    } catch (error) {
      this.showError(error.message || 'ç™»å½•å¤±è´¥')
      // åŸ‹ç‚¹ç»Ÿè®¡å¤±è´¥
      this.trackLoginFailure('wechat', error.message)
    } finally {
      this.setData({ isLoading: false })
    }
  },

  // æ‰‹æœºå·ç™»å½•
  async loginWithPhone() {
    if (this.data.isLoading) return  // é˜²æ­¢é‡å¤ç‚¹å‡»
    
    try {
      this.setData({ isLoading: true })

      // 1. è°ƒç”¨è®¤è¯æœåŠ¡
      const result = await auth.loginWithPhone()

      // 2. æ£€æŸ¥èº«ä»½
      if (!result.userInfo.identity) {
        wx.navigateTo({ url: '/pages/login/identity/index' })
      } else {
        wx.redirectTo({ url: '/pages/index/index' })
      }
      
      this.trackLoginSuccess('phone')
    } catch (error) {
      this.showError(error.message || 'ç™»å½•å¤±è´¥')
      this.trackLoginFailure('phone', error.message)
    } finally {
      this.setData({ isLoading: false })
    }
  },

  // æ¸¸å®¢æ¨¡å¼ â­ åç«¯éœ€æ”¯æŒ guestToken
  async loginAsGuest() {
    try {
      this.setData({ isLoading: true })
      
      // å‘åç«¯ç”³è¯· guestTokenï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä¸è¦tokenï¼‰
      // const guestToken = await auth.loginAsGuest()
      
      // ç®€å•æ–¹æ¡ˆï¼šä»…æ ‡è®°ä¸ºæ¸¸å®¢ï¼Œåç«¯æ¥å£æ£€æŸ¥æƒé™
      wx.setStorageSync('isGuest', true)
      app.globalData.isGuest = true
      
      this.trackLoginSuccess('guest')
      wx.redirectTo({ url: '/pages/index/index' })
    } catch (error) {
      this.showError(error.message || 'è¿›å…¥æ¸¸å®¢æ¨¡å¼å¤±è´¥')
    } finally {
      this.setData({ isLoading: false })
    }
  },

  // åŸ‹ç‚¹ç»Ÿè®¡ï¼šç™»å½•æˆåŠŸ
  trackLoginSuccess(method) {
    // TODO: æ¥å…¥æ•°æ®åˆ†æå¹³å°ï¼ˆå¦‚å‹ç›Ÿã€ç™¾åº¦ç­‰ï¼‰
    console.log(`[Analytics] ç™»å½•æˆåŠŸ - æ–¹å¼: ${method}`)
  },

  // åŸ‹ç‚¹ç»Ÿè®¡ï¼šç™»å½•å¤±è´¥
  trackLoginFailure(method, reason) {
    // TODO: æ¥å…¥æ•°æ®åˆ†æå¹³å°
    console.log(`[Analytics] ç™»å½•å¤±è´¥ - æ–¹å¼: ${method}, åŸå› : ${reason}`)
  },

  // æ˜¾ç¤ºé”™è¯¯æç¤º
  showError(message) {
    wx.showToast({
      title: message,
      icon: 'error',
      duration: 2000
    })
  }
})
```

#### WXSS æ ·å¼

```wxss
/* ç™»å½•é¡µé¢æ ·å¼ */

/* ä¸»é¢˜å˜é‡ */
.page.light {
  --bg-page: #f5f5f5;
  --bg-card: #fff;
  --text-primary: #333;
  --text-secondary: #666;
  --border-color: #e0e0e0;
}

.page.dark-mode {
  --bg-page: #1a1a1a;
  --bg-card: #2a2a2a;
  --text-primary: #f0f0f0;
  --text-secondary: #999;
  --border-color: #3a3a3a;
}

.page {
  min-height: 100vh;
  background-color: var(--bg-page);
  padding: 40rpx 30rpx;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

/* å“ç‰ŒåŒºåŸŸ */
.logo-section {
  text-align: center;
  margin-bottom: 80rpx;
}

.logo {
  font-size: 120rpx;
  display: block;
  margin-bottom: 20rpx;
}

.app-name {
  font-size: 40rpx;
  font-weight: 600;
  color: var(--text-primary);
  display: block;
  margin-bottom: 16rpx;
}

.slogan {
  font-size: 28rpx;
  color: var(--text-secondary);
  display: block;
}

/* ç™»å½•æ–¹å¼ */
.login-methods {
  margin-bottom: 60rpx;
}

.login-btn {
  width: 100%;
  height: 88rpx;
  border-radius: 44rpx;
  font-size: 32rpx;
  font-weight: 500;
  margin-bottom: 20rpx;
  background: var(--bg-card);
  color: var(--text-primary);
  border: none;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
}

.page.dark-mode .login-btn {
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.3);
}

.wechat-btn {
  background: #07c160;
  color: #fff;
}

.phone-btn {
  background: #1890ff;
  color: #fff;
}

.guest-btn {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 2rpx solid var(--border-color);
}

.login-btn:active {
  opacity: 0.8;
}

/* ç”¨æˆ·åè®® */
.agreement {
  text-align: center;
  margin-bottom: 30rpx;
}

.agreement .text {
  font-size: 24rpx;
  color: var(--text-secondary);
  line-height: 1.6;
}

.agreement .link {
  color: #1890ff;
  text-decoration: underline;
}

/* åŠ è½½çŠ¶æ€ */
.loading {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.spinner {
  width: 60rpx;
  height: 60rpx;
  border: 3rpx solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading text {
  color: #fff;
  margin-top: 20rpx;
  font-size: 28rpx;
}

/* è€äººç‰ˆ */
.elderly-mode .logo {
  font-size: 160rpx;
}

.elderly-mode .app-name {
  font-size: 56rpx;
}

.elderly-mode .slogan {
  font-size: 36rpx;
}

.elderly-mode .login-btn {
  height: 120rpx;
  font-size: 40rpx;
  margin-bottom: 30rpx;
}

.elderly-mode .agreement .text {
  font-size: 32rpx;
}
```

### 2. èº«ä»½é€‰æ‹©é¡µé¢ï¼ˆpages/login/identityï¼‰

```javascript
// pages/login/identity/index.js
const app = getApp()

Page({
  data: {
    theme: 'light',
    appVersion: 'standard',
    selectedIdentity: null,  // 'villager' | 'visitor'
    isSubmitting: false
  },

  onLoad() {
    this.setData({
      theme: app.globalData.theme,
      appVersion: app.globalData.appVersion
    })
  },

  // é€‰æ‹©èº«ä»½
  selectIdentity(e) {
    const identity = e.currentTarget.dataset.identity
    this.setData({ selectedIdentity: identity })
  },

  // ç¡®è®¤èº«ä»½
  async submitIdentity() {
    if (!this.data.selectedIdentity) {
      wx.showToast({
        title: 'è¯·é€‰æ‹©èº«ä»½',
        icon: 'error'
      })
      return
    }

    try {
      this.setData({ isSubmitting: true })

      // å‘é€èº«ä»½ä¿¡æ¯åˆ°åç«¯
      const response = await this.updateIdentity(
        this.data.selectedIdentity
      )

      if (response.code === 0) {
        // æ›´æ–°å…¨å±€çŠ¶æ€
        app.globalData.userInfo.identity = this.data.selectedIdentity
        
        // è¿›å…¥é¦–é¡µ
        wx.redirectTo({ url: '/pages/index/index' })
      } else {
        wx.showToast({
          title: response.message || 'è®¾ç½®èº«ä»½å¤±è´¥',
          icon: 'error'
        })
      }
    } catch (error) {
      wx.showToast({
        title: error.message || 'ç½‘ç»œé”™è¯¯',
        icon: 'error'
      })
    } finally {
      this.setData({ isSubmitting: false })
    }
  },

  // è¯·æ±‚æ›´æ–°èº«ä»½
  updateIdentity(identity) {
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${app.api.baseURL}/api/user/identity`,
        method: 'PATCH',
        header: {
          'Authorization': `Bearer ${app.globalData.token}`
        },
        data: { identity },
        success(res) {
          resolve(res.data)
        },
        fail(err) {
          reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'))
        }
      })
    })
  }
})
```

### 3. HTTP æ‹¦æˆªå™¨å‡çº§ï¼ˆservices/http.tsï¼‰â­ å…³é”®æ”¹è¿›

```typescript
// services/http.ts
const app = getApp()

// â­ åˆ·æ–°é˜Ÿåˆ—æœºåˆ¶ï¼šé˜²æ­¢å¹¶å‘ 401 æ—¶å¤šæ¬¡é‡å®šå‘
let isRefreshing = false
let pendingRequests: any[] = []

/**
 * æ·»åŠ å¾…å¤„ç†è¯·æ±‚
 */
function addPendingRequest(callback: any) {
  pendingRequests.push(callback)
}

/**
 * é‡è¯•æ‰€æœ‰å¾…å¤„ç†è¯·æ±‚
 */
function retryPendingRequests(accessToken: string) {
  pendingRequests.forEach(callback => {
    callback(accessToken)
  })
  pendingRequests = []
}

/**
 * ç»Ÿä¸€çš„ HTTP è¯·æ±‚æ–¹æ³•
 * è‡ªåŠ¨æ³¨å…¥ accessTokenï¼Œå¤„ç†è®¤è¯å¤±è´¥ + è‡ªåŠ¨åˆ·æ–°
 */
export function request(
  url: string,
  options: any = {}
): Promise<any> {
  return new Promise((resolve, reject) => {
    const accessToken = wx.getStorageSync('accessToken')  // â­ ä½¿ç”¨ accessToken

    const header = {
      ...options.header,
      'Content-Type': 'application/json'
    }

    // è‡ªåŠ¨æ³¨å…¥ accessToken
    if (accessToken) {
      header['Authorization'] = `Bearer ${accessToken}`
    }

    wx.request({
      url: `${app.api.baseURL}${url}`,
      method: options.method || 'GET',
      data: options.data,
      header,
      success(res) {
        // å¤„ç† 401 - accessToken è¿‡æœŸ
        if (res.statusCode === 401) {
          if (isRefreshing) {
            // å·²åœ¨åˆ·æ–°ä¸­ï¼ŒåŠ å…¥å¾…å¤„ç†é˜Ÿåˆ—
            addPendingRequest((newAccessToken: string) => {
              // ä½¿ç”¨æ–° token é‡è¯•åŸè¯·æ±‚
              const newHeader = { ...header }
              newHeader['Authorization'] = `Bearer ${newAccessToken}`
              
              wx.request({
                url: `${app.api.baseURL}${url}`,
                method: options.method || 'GET',
                data: options.data,
                header: newHeader,
                success: (retryRes) => {
                  if (retryRes.statusCode >= 200 && retryRes.statusCode < 300) {
                    resolve(retryRes.data)
                  } else {
                    reject(new Error(retryRes.data?.message || 'è¯·æ±‚å¤±è´¥'))
                  }
                },
                fail: reject
              })
            })
          } else {
            // ç¬¬ä¸€æ¬¡ 401ï¼Œå¼€å§‹åˆ·æ–° token
            isRefreshing = true
            handleTokenExpired()
              .then((newAccessToken) => {
                // åˆ·æ–°æˆåŠŸï¼Œé‡è¯•åŸè¯·æ±‚
                isRefreshing = false
                retryPendingRequests(newAccessToken)
                
                // é‡è¯•åŸè¯·æ±‚
                const newHeader = { ...header }
                newHeader['Authorization'] = `Bearer ${newAccessToken}`
                
                wx.request({
                  url: `${app.api.baseURL}${url}`,
                  method: options.method || 'GET',
                  data: options.data,
                  header: newHeader,
                  success: (retryRes) => {
                    resolve(retryRes.data)
                  },
                  fail: reject
                })
              })
              .catch((err) => {
                // åˆ·æ–°å¤±è´¥
                isRefreshing = false
                pendingRequests = []
                reject(err)
              })
          }
          return
        }

        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data)
        } else if (res.statusCode === 403) {
          reject(new Error('æƒé™ä¸è¶³'))
        } else {
          reject(new Error(res.data?.message || 'è¯·æ±‚å¤±è´¥'))
        }
      },
      fail(error) {
        reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'))
      }
    })
  })
}

/**
 * å¤„ç† token è¿‡æœŸ - ä½¿ç”¨ refreshToken åˆ·æ–°
 */
function handleTokenExpired(): Promise<string> {
  return new Promise((resolve, reject) => {
    const refreshToken = wx.getStorageSync('refreshToken')
    
    if (!refreshToken) {
      // æ²¡æœ‰ refreshTokenï¼Œæ— æ³•åˆ·æ–°ï¼Œéœ€è¦é‡æ–°ç™»å½•
      clearAuth()
      reject(new Error('token å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'))
      return
    }

    // â­ å…³é”®ï¼šç”¨ refreshToken è°ƒç”¨åˆ·æ–°æ¥å£
    wx.request({
      url: `${app.api.baseURL}/api/auth/refresh`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${refreshToken}`,
        'Content-Type': 'application/json'
      },
      success(res) {
        if (res.statusCode === 200) {
          const { accessToken, refreshToken: newRefreshToken } = res.data.data
          
          // ä¿å­˜æ–°çš„ tokens
          wx.setStorageSync('accessToken', accessToken)
          if (newRefreshToken) {
            wx.setStorageSync('refreshToken', newRefreshToken)
          }
          
          app.globalData.accessToken = accessToken
          
          resolve(accessToken)
        } else {
          // åˆ·æ–°å¤±è´¥
          clearAuth()
          reject(new Error('token åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•'))
        }
      },
      fail(error) {
        clearAuth()
        reject(new Error('åˆ·æ–° token ç½‘ç»œé”™è¯¯'))
      }
    })
  })
}

/**
 * æ¸…ç©ºè®¤è¯ä¿¡æ¯
 */
function clearAuth() {
  // æ¸…ç©ºå…¨å±€çŠ¶æ€
  app.globalData.accessToken = null
  app.globalData.refreshToken = null
  app.globalData.userInfo = null
  app.globalData.isLogin = false

  // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
  wx.removeStorageSync('accessToken')
  wx.removeStorageSync('refreshToken')
  wx.removeStorageSync('userInfo')

  // æ˜¾ç¤ºæç¤º
  wx.showToast({
    title: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
    icon: 'error',
    duration: 2000
  })

  // é‡å®šå‘åˆ°ç™»å½•é¡µ
  setTimeout(() => {
    wx.redirectTo({
      url: '/pages/login/index'
    })
  }, 2000)
}
```

### 4. åº”ç”¨å…¥å£å‡çº§ï¼ˆapp.jsï¼‰â­ ä½¿ç”¨ request ç»Ÿä¸€ç®¡ç†

```javascript
// app.js
const auth = require('./services/auth')  // â­ ç»Ÿä¸€è®¤è¯æœåŠ¡
const { request } = require('./services/http')  // â­ ç»Ÿä¸€ HTTP

App({
  onLaunch() {
    console.log('æ—…å±…æœåŠ¡ç«™å°ç¨‹åºå¯åŠ¨')
    
    // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
    this.initAuth()
    
    // åˆå§‹åŒ–ä¸»é¢˜
    this.initTheme()
  },

  globalData: {
    userInfo: null,
    accessToken: null,      // â­ çŸ­æœŸ tokenï¼ˆ1~2å°æ—¶ï¼‰
    refreshToken: null,     // â­ é•¿æœŸ tokenï¼ˆ7å¤©ï¼‰
    isLogin: false,
    isGuest: false,
    theme: 'light',
    appVersion: 'standard'
  },

  api: {
    baseURL: 'https://api.example.com'  // è¯·æ›¿æ¢ä¸ºçœŸå® API åœ°å€
  },

  // åˆå§‹åŒ–è®¤è¯ â­ æ”¹ä¸ºè¯»å– accessToken
  initAuth() {
    const accessToken = wx.getStorageSync('accessToken')
    const refreshToken = wx.getStorageSync('refreshToken')
    const userInfoStr = wx.getStorageSync('userInfo')
    const isGuest = wx.getStorageSync('isGuest')

    if (accessToken && refreshToken) {
      try {
        this.globalData.accessToken = accessToken
        this.globalData.refreshToken = refreshToken
        this.globalData.userInfo = userInfoStr ? JSON.parse(userInfoStr) : null
        this.globalData.isLogin = true
        
        // å¼‚æ­¥éªŒè¯ token æœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼‰
        // this.verifyToken()
      } catch (error) {
        console.error('è®¤è¯åˆå§‹åŒ–å¤±è´¥:', error)
        this.clearAuth()
      }
    }

    if (isGuest) {
      this.globalData.isGuest = true
    }
  },

  // éªŒè¯ tokenï¼ˆå¯é€‰ï¼‰
  verifyToken() {
    request('/api/auth/verify', { method: 'GET' })
      .catch(() => {
        // token éªŒè¯å¤±è´¥
        this.clearAuth()
      })
  },

  // åˆå§‹åŒ–ä¸»é¢˜
  initTheme() {
    const theme = wx.getStorageSync('theme') || 'light'
    const appVersion = wx.getStorageSync('appVersion') || 'standard'
    
    this.globalData.theme = theme
    this.globalData.appVersion = appVersion
  },

  // è®¾ç½®ä¸»é¢˜
  setTheme(theme) {
    this.globalData.theme = theme
    wx.setStorageSync('theme', theme)
    
    const pages = getCurrentPages()
    pages.forEach(page => {
      page.setData({ theme })
    })
  },

  // è®¾ç½®åº”ç”¨ç‰ˆæœ¬
  setAppVersion(version) {
    this.globalData.appVersion = version
    wx.setStorageSync('appVersion', version)
    
    const pages = getCurrentPages()
    pages.forEach(page => {
      page.setData({ appVersion: version })
    })
  },

  // ç™»å‡º â­ ä½¿ç”¨ request
  async logout() {
    try {
      // è°ƒç”¨åç«¯ç™»å‡ºæ¥å£
      await request('/api/auth/logout', { method: 'POST' })
    } catch (error) {
      console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error)
    } finally {
      // æ¸…ç©ºæœ¬åœ°çŠ¶æ€
      this.clearAuth()

      // é‡å®šå‘åˆ°ç™»å½•é¡µ
      wx.navigateTo({
        url: '/pages/login/index'
      })
    }
  },

  // æ¸…ç©ºè®¤è¯ä¿¡æ¯
  clearAuth() {
    this.globalData.accessToken = null
    this.globalData.refreshToken = null
    this.globalData.userInfo = null
    this.globalData.isLogin = false

    // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
    wx.removeStorageSync('accessToken')
    wx.removeStorageSync('refreshToken')
    wx.removeStorageSync('userInfo')
  }
})
```

---

## åç«¯æ¥å£

### API ç«¯ç‚¹å®šä¹‰

#### 1. å¾®ä¿¡ç™»å½•

```http
POST /api/auth/login
Content-Type: application/json

{
  "code": "string",           // wx.login() è¿”å›çš„ code
  "userInfo": {
    "nickName": "string",
    "avatarUrl": "string",
    "gender": 0|1|2,
    "province": "string",
    "city": "string"
  },
  "method": "wechat"          // ç™»å½•æ–¹å¼
}

Response 200:
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "string",        // JWT token
    "userInfo": {
      "id": "string",
      "nickName": "string",
      "avatarUrl": "string",
      "gender": 0|1|2
    },
    "isNewUser": true|false   // æ˜¯å¦é¦–æ¬¡ç”¨æˆ·
  }
}
```

#### 2. æ‰‹æœºå·ç™»å½•

```http
POST /api/auth/login
Content-Type: application/json

{
  "phoneNumber": "string",    // è¿è¥å•†è·å–çš„æ‰‹æœºå·
  "method": "phone"
}

Response 200:
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "string",
    "userInfo": {...},
    "isNewUser": boolean
  }
}
```

#### 3. ç™»å‡º

```http
POST /api/auth/logout
Authorization: Bearer <token>

Response 200:
{
  "code": 0,
  "message": "logout success"
}
```

#### 4. Token éªŒè¯

```http
GET /api/auth/verify
Authorization: Bearer <token>

Response 200:
{
  "code": 0,
  "message": "token valid"
}

Response 401:
{
  "code": 401,
  "message": "token expired or invalid"
}
```

#### 5. Token åˆ·æ–°

```http
POST /api/auth/refresh
Authorization: Bearer <token>

Response 200:
{
  "code": 0,
  "data": {
    "token": "string"  // æ–° token
  }
}

Response 401:
{
  "code": 401,
  "message": "refresh token expired"
}
```

#### 6. æ›´æ–°èº«ä»½

```http
PATCH /api/user/identity
Authorization: Bearer <token>
Content-Type: application/json

{
  "identity": "villager" | "visitor"  // èº«ä»½ç±»å‹
}

Response 200:
{
  "code": 0,
  "message": "identity updated",
  "data": {
    "identity": "string"
  }
}
```

---

## æ•°æ®æ¨¡å‹

### ç”¨æˆ·è®¤è¯æ•°æ® â­ åŒ Token æ¨¡å¼

```typescript
// types/auth.ts

/**
 * ğŸ”‘ åŒ Token æ¨¡å¼
 * accessToken: çŸ­æœŸï¼ˆ1~2å°æ—¶ï¼‰ï¼Œç”¨äº API è¯·æ±‚
 * refreshToken: é•¿æœŸï¼ˆ7å¤©ï¼‰ï¼Œç”¨äºåˆ·æ–° accessToken
 */
interface AuthTokens {
  accessToken: string       // çŸ­æœŸ tokenï¼ˆ1~2å°æ—¶ï¼‰
  refreshToken: string      // é•¿æœŸ tokenï¼ˆ7å¤©ï¼‰
  expiresIn: number         // accessToken è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}

/**
 * ç™»å½•è¯·æ±‚
 */
interface LoginRequest {
  code?: string              // å¾®ä¿¡ç™»å½• code
  phoneNumber?: string       // æ‰‹æœºå·
  userInfo?: {
    nickName: string
    avatarUrl: string
    gender: 0 | 1 | 2       // 0æœªçŸ¥ 1ç”· 2å¥³
    province?: string
    city?: string
  }
  method: 'wechat' | 'phone' | 'guest'
}

/**
 * ç™»å½•å“åº”
 */
interface LoginResponse {
  accessToken: string       // â­ çŸ­æœŸ token
  refreshToken: string      // â­ é•¿æœŸ token
  expiresIn: number         // token è¿‡æœŸæ—¶é—´
  userInfo: {
    id: string
    nickName: string
    avatarUrl: string
    gender: 0 | 1 | 2
    identity?: 'villager' | 'visitor'
    createdAt: string
  }
}

/**
 * ç”¨æˆ·ä¿¡æ¯ï¼ˆå®Œæ•´ï¼‰
 */
interface UserInfo {
  id: string
  nickName: string
  avatarUrl: string
  gender: 0 | 1 | 2
  identity: 'villager' | 'visitor'
  phone?: string
  province: string
  city: string
  signature?: string
  level?: number            // ç”¨æˆ·ç­‰çº§
  createdAt: string
  updatedAt: string
}

/**
 * è®¤è¯çŠ¶æ€
 */
interface AuthState {
  accessToken: string | null
  refreshToken: string | null
  userInfo: UserInfo | null
  isLogin: boolean
  isGuest: boolean
}
```

---

## å®‰å…¨ç­–ç•¥ â­ ç”Ÿäº§çº§è§„èŒƒ

### 1. Token ç®¡ç†ï¼ˆåŒ Token æ¨¡å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Token ç”Ÿå‘½å‘¨æœŸç®¡ç†              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

accessTokenï¼ˆçŸ­æœŸï¼‰
â”œâ”€ æœ‰æ•ˆæœŸ: 1~2 å°æ—¶
â”œâ”€ ç”¨é€”: æ‰€æœ‰ API è¯·æ±‚çš„è®¤è¯
â”œâ”€ é£é™©: è¢«ç›—åå½±å“èŒƒå›´é™åˆ¶åœ¨ 1~2 å°æ—¶
â””â”€ åˆ·æ–°æ–¹å¼: ä½¿ç”¨ refreshToken åˆ·æ–°

refreshTokenï¼ˆé•¿æœŸï¼‰
â”œâ”€ æœ‰æ•ˆæœŸ: 7 å¤©
â”œâ”€ ç”¨é€”: ç”³è¯·æ–°çš„ accessToken
â”œâ”€ å­˜å‚¨: å®‰å…¨å­˜å‚¨ï¼Œä¸èƒ½æ³„éœ²
â””â”€ åˆ·æ–°æ–¹å¼: å®šæœŸè½®æ¢
```

- **å­˜å‚¨**: ä½¿ç”¨ `wx.setStorageSync()` æœ¬åœ°å­˜å‚¨ï¼ˆå¾®ä¿¡åº•å±‚åŠ å¯†ï¼‰
- **ä¼ è¾“**: HTTPS + Authorization header æ–¹å¼å‘é€
- **accessToken è¿‡æœŸæ—¶é—´**: 1~2 å°æ—¶ï¼ˆä¸å»ºè®®è¶…è¿‡ 2 å°æ—¶ï¼‰
- **refreshToken è¿‡æœŸæ—¶é—´**: 7 å¤©ï¼ˆä¸å»ºè®®è¶…è¿‡ 7 å¤©ï¼‰
- **åˆ·æ–°æœºåˆ¶**: accessToken è¿‡æœŸè‡ªåŠ¨è°ƒç”¨ `/api/auth/refresh` ç”¨ refreshToken åˆ·æ–°
- **é˜²æŠ¤**: å¯ç”¨ refresh é˜Ÿåˆ—æœºåˆ¶ï¼Œé˜²æ­¢å¹¶å‘ 401

### 2. èº«ä»½éªŒè¯ä¸æƒé™éš”ç¦»

```javascript
// æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkAuth() {
  const accessToken = getApp().globalData.accessToken
  const isLogin = getApp().globalData.isLogin
  
  if (!accessToken || !isLogin) {
    wx.navigateTo({ url: '/pages/login/index' })
    return false
  }
  return true
}

// æ£€æŸ¥æ¸¸å®¢æƒé™ï¼ˆéƒ¨åˆ†åŠŸèƒ½éœ€ç™»å½•ï¼‰
function requireLogin() {
  const isGuest = getApp().globalData.isGuest
  const isLogin = getApp().globalData.isLogin
  
  if (isGuest || !isLogin) {
    wx.showToast({
      title: 'è¯·å…ˆç™»å½•',
      icon: 'error'
    })
    setTimeout(() => {
      wx.navigateTo({ url: '/pages/login/index' })
    }, 1500)
    return false
  }
  return true
}

// é¡µé¢ä½¿ç”¨ç¤ºä¾‹
Page({
  onLoad() {
    if (!checkAuth()) return
    this.loadData()
  },
  
  publishPost() {
    // å‘å¸ƒéœ€è¦ç™»å½•
    if (!requireLogin()) return
    // ... å‘å¸ƒé€»è¾‘
  }
})
```

### 3. èº«ä»½æƒé™æ§åˆ¶

```javascript
// æ£€æŸ¥ç”¨æˆ·èº«ä»½ï¼ˆæ‘æ°‘/æ¸¸æ°‘/æ¸¸å®¢ï¼‰
function checkIdentity(requiredIdentity: string | string[]) {
  const userInfo = getApp().globalData.userInfo
  const isGuest = getApp().globalData.isGuest
  
  // æ¸¸å®¢ä¸èƒ½æ‰§è¡Œå—é™æ“ä½œ
  if (isGuest) {
    wx.showToast({
      title: 'æ¸¸å®¢æ— æƒæ“ä½œï¼Œè¯·ç™»å½•',
      icon: 'error'
    })
    return false
  }
  
  const required = Array.isArray(requiredIdentity) ? requiredIdentity : [requiredIdentity]
  const userIdentity = userInfo?.identity
  
  if (!userIdentity || !required.includes(userIdentity)) {
    wx.showToast({
      title: 'æƒé™ä¸è¶³',
      icon: 'error'
    })
    return false
  }
  return true
}

// ä½¿ç”¨ç¤ºä¾‹
Page({
  // åªæœ‰æ‘æ°‘å¯ä»¥å‘å¸ƒæˆ¿æº
  async publishHouse() {
    if (!checkIdentity('villager')) return
    // ... å‘å¸ƒé€»è¾‘
  },
  
  // æ‘æ°‘å’Œæ¸¸æ°‘éƒ½å¯ä»¥å‘å¸ƒæŠ€èƒ½
  async publishSkill() {
    if (!checkIdentity(['villager', 'visitor'])) return
    // ... å‘å¸ƒé€»è¾‘
  }
})
```

### 4. æ¸¸å®¢æ¨¡å¼æƒé™éš”ç¦»

**æ¸¸å®¢æ¨¡å¼é™åˆ¶**ï¼š
- âŒ ä¸èƒ½å‘å¸ƒå†…å®¹
- âŒ ä¸èƒ½åˆ›å»ºè®¢å•
- âŒ ä¸èƒ½è¯„è®º
- âŒ ä¸èƒ½æ”¶è—ï¼ˆå¯é€‰ï¼‰
- âœ… å¯ä»¥æµè§ˆå†…å®¹
- âœ… å¯ä»¥æœç´¢
- âœ… å¯ä»¥æŸ¥çœ‹è¯¦æƒ…

**å®ç°æ–¹å¼**ï¼š

æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰ï¼šä¸å‘ token ç»™æ¸¸å®¢
```javascript
// æ¸¸å®¢æ¨¡å¼ä¸‹ï¼Œrequest() å‡½æ•°æ£€æŸ¥
if (isGuest && needsAuth) {
  return Promise.reject('éœ€è¦ç™»å½•')
}
```

æ–¹æ¡ˆ 2ï¼šå‘ guestTokenï¼Œåç«¯æ£€æŸ¥æƒé™
```javascript
// åç«¯ middleware æ£€æŸ¥ token ç±»å‹
if (tokenType === 'guest' && isDangerousOperation) {
  return 403  // æƒé™ä¸è¶³
}
```

### 5. HTTPS + IP è®°å½•

- **HTTPS å¼ºåˆ¶**: å¾®ä¿¡å°ç¨‹åºé»˜è®¤å¼ºåˆ¶ HTTPS
- **IP è®°å½•**: åç«¯åº”è®°å½•ç™»å½• IPï¼Œç”¨äºå¼‚å¸¸æ£€æµ‹
- **å¤±è´¥é™åˆ¶**: ç™»å½•å¤±è´¥ 10 æ¬¡é”å®š IP 1 å°æ—¶
- **ç™»å½•é€šçŸ¥**: æ–°è®¾å¤‡ç™»å½•å‘é€çŸ­ä¿¡éªŒè¯ç 

---

## é”™è¯¯å¤„ç†

### HTTP é”™è¯¯ç å¤„ç†

```javascript
const errorMessages = {
  400: 'è¯·æ±‚å‚æ•°é”™è¯¯',
  401: 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•',
  403: 'æƒé™ä¸è¶³',
  404: 'è¯·æ±‚èµ„æºä¸å­˜åœ¨',
  500: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
  502: 'ç½‘å…³é”™è¯¯',
  503: 'æœåŠ¡ä¸å¯ç”¨'
}

function handleHttpError(statusCode) {
  return errorMessages[statusCode] || 'æœªçŸ¥é”™è¯¯'
}
```

### å¸¸è§é”™è¯¯åœºæ™¯

| åœºæ™¯ | é”™è¯¯ç  | å¤„ç†æ–¹æ¡ˆ |
|------|--------|---------|
| ç™»å½•æ—¶å‚æ•°é”™è¯¯ | 400 | æ˜¾ç¤ºè¡¨å•é”™è¯¯æç¤º |
| token è¿‡æœŸ | 401 | è°ƒç”¨ refreshï¼Œå¤±è´¥åˆ™é‡å®šå‘ç™»å½• |
| æ— æƒé™æ‰§è¡Œæ“ä½œ | 403 | æç¤ºæƒé™ä¸è¶³ |
| ç½‘ç»œæ–­å¼€ | ç½‘ç»œé”™è¯¯ | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| æœåŠ¡å™¨é”™è¯¯ | 500+ | æç¤ºé”™è¯¯å¹¶å»ºè®®è”ç³»å®¢æœ |

---

## æµ‹è¯•æ¸…å•

### âœ… åŠŸèƒ½æµ‹è¯•

#### å¾®ä¿¡ç™»å½•æµç¨‹
- [ ] ç‚¹å‡»å¾®ä¿¡ç™»å½•æŒ‰é’®ï¼Œå¼¹å‡ºæˆæƒç¡®è®¤
- [ ] æˆæƒåï¼Œè·å– code å’Œç”¨æˆ·ä¿¡æ¯
- [ ] åç«¯è¿”å› token å’Œ userInfo
- [ ] é¦–æ¬¡ç”¨æˆ·è¿›å…¥èº«ä»½é€‰æ‹©é¡µé¢
- [ ] å·²æ³¨å†Œç”¨æˆ·ç›´æ¥è¿›å…¥é¦–é¡µ
- [ ] token ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

#### èº«ä»½é€‰æ‹©æµç¨‹
- [ ] æ˜¾ç¤ºæ‘æ°‘å’Œæ¸¸æ°‘ä¸¤ç§èº«ä»½é€‰é¡¹
- [ ] é€‰ä¸­èº«ä»½åï¼ŒæŒ‰é’®é«˜äº®æ˜¾ç¤º
- [ ] ç‚¹å‡»ç¡®è®¤ï¼Œå‘é€ PATCH è¯·æ±‚
- [ ] èº«ä»½æ›´æ–°æˆåŠŸåè¿›å…¥é¦–é¡µ

#### ç™»å‡ºæµç¨‹
- [ ] è®¾ç½®é¡µç‚¹å‡»ç™»å‡ºæŒ‰é’®
- [ ] å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- [ ] ç¡®è®¤åè°ƒç”¨ `/api/auth/logout`
- [ ] æ¸…ç©ºæœ¬åœ° token å’Œ userInfo
- [ ] é‡å®šå‘åˆ°ç™»å½•é¡µé¢

#### Token ç®¡ç†
- [ ] åº”ç”¨å¯åŠ¨æ—¶è¯»å–æœ¬åœ° token
- [ ] token æœ‰æ•ˆæ—¶è‡ªåŠ¨ç™»å½•ï¼ˆä¸æ˜¾ç¤ºç™»å½•é¡µï¼‰
- [ ] token è¿‡æœŸæ—¶æç¤ºé‡æ–°ç™»å½•
- [ ] token å¤±æ•ˆæ—¶æ¸…ç©ºæœ¬åœ°æ•°æ®

#### HTTP è¯·æ±‚
- [ ] æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨æ³¨å…¥ Authorization header
- [ ] 401 é”™è¯¯è‡ªåŠ¨é‡å®šå‘ç™»å½•é¡µ
- [ ] ç½‘ç»œé”™è¯¯æ˜¾ç¤ºé‡è¯•æç¤º

### âœ… æ ·å¼æµ‹è¯•

#### æ·±è‰²æ¨¡å¼
- [ ] ç™»å½•é¡µåœ¨æ·±è‰²æ¨¡å¼ä¸‹å®Œå…¨é»‘è‰²
- [ ] æŒ‰é’®é¢œè‰²åœ¨æ·±è‰²æ¨¡å¼ä¸‹é€‚é…
- [ ] æ–‡å­—é¢œè‰²åœ¨æ·±è‰²æ¨¡å¼ä¸‹æ¸…æ™°å¯è¯»
- [ ] èº«ä»½é€‰æ‹©é¡µæ·±è‰²æ¨¡å¼é€‚é…

#### è€äººå‹å¥½ç‰ˆ
- [ ] ç™»å½•é¡µå­—ä½“æ”¾å¤§
- [ ] æŒ‰é’®æ˜¾è‘—æ”¾å¤§
- [ ] é—´è·æ‰©å¤§ï¼Œä¾¿äºç‚¹å‡»
- [ ] æ–‡å­—å¤§å°é€‚å½“å¢åŠ 

### âœ… å…¼å®¹æ€§æµ‹è¯•

- [ ] iOS å¾®ä¿¡å®¢æˆ·ç«¯
- [ ] Android å¾®ä¿¡å®¢æˆ·ç«¯
- [ ] å„ç§å±å¹•å°ºå¯¸ï¼ˆiPhone 6/X/XS Max ç­‰ï¼‰
- [ ] å¾®ä¿¡æœ€æ–°ç‰ˆæœ¬
- [ ] ä½ç‰ˆæœ¬å¾®ä¿¡ï¼ˆ6.7.0+ï¼‰

### âœ… æ€§èƒ½æµ‹è¯•

- [ ] ç™»å½•è¯·æ±‚å“åº”æ—¶é—´ < 3 ç§’
- [ ] token åˆ·æ–°å“åº”æ—¶é—´ < 1 ç§’
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 2 ç§’
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥

---

## å¼€å‘æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šå‰ç«¯é¡µé¢å¼€å‘ï¼ˆé¢„è®¡ 3 å°æ—¶ï¼‰

- [ ] åˆ›å»º `pages/login/` ç›®å½•
- [ ] å¼€å‘ç™»å½•é€‰æ‹©é¡µé¢ï¼ˆWXML + JS + WXSSï¼‰
- [ ] å¼€å‘èº«ä»½é€‰æ‹©é¡µé¢
- [ ] å®ç°é¡µé¢é—´å¯¼èˆªé€»è¾‘
- [ ] åŠ å…¥æ·±è‰²æ¨¡å¼å’Œè€äººç‰ˆæ”¯æŒ

### ç¬¬äºŒé˜¶æ®µï¼šè®¤è¯æœåŠ¡å®ç°ï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

- [ ] åˆ›å»º `services/auth.ts`
- [ ] å®ç°å¾®ä¿¡ç™»å½•é€»è¾‘
- [ ] å®ç° token ç®¡ç†
- [ ] å‡çº§ HTTP æ‹¦æˆªå™¨
- [ ] å®ç°é”™è¯¯å¤„ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šåº”ç”¨å…¥å£å‡çº§ï¼ˆé¢„è®¡ 1 å°æ—¶ï¼‰

- [ ] ä¿®æ”¹ `app.js` åˆå§‹åŒ–é€»è¾‘
- [ ] å®ç°è®¤è¯çŠ¶æ€åˆå§‹åŒ–
- [ ] å®ç° token åˆ·æ–°æœºåˆ¶
- [ ] å®ç°ç™»å‡ºåŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šç«¯åˆ°ç«¯é›†æˆï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

- [ ] ä¸åç«¯ API å¯¹æ¥
- [ ] æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹
- [ ] æµ‹è¯• token è¿‡æœŸå¤„ç†
- [ ] æµ‹è¯•å¤šé¡µé¢è®¤è¯åŒæ­¥
- [ ] ä¿®å¤å‘ç°çš„é—®é¢˜

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

- [ ] åŠŸèƒ½æµ‹è¯•ï¼ˆæ‰€æœ‰ç”¨ä¾‹ï¼‰
- [ ] æ ·å¼æµ‹è¯•ï¼ˆæ·±è‰²æ¨¡å¼ã€è€äººç‰ˆï¼‰
- [ ] å…¼å®¹æ€§æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

---

## ä¾èµ–å…³ç³»

```
åº”ç”¨å¯åŠ¨ (app.js)
    â”œâ”€ åˆå§‹åŒ–è®¤è¯ (initAuth)
    â”œâ”€ è¯»å–æœ¬åœ° token
    â””â”€ éªŒè¯ token æœ‰æ•ˆæ€§
         â”œâ”€ æœ‰æ•ˆ â†’ è‡ªåŠ¨ç™»å½•ï¼ˆæ— éœ€æ˜¾ç¤ºç™»å½•é¡µï¼‰
         â””â”€ æ— æ•ˆ â†’ æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œæ˜¾ç¤ºç™»å½•é¡µ

é¦–é¡µåŠ è½½ (pages/index)
    â”œâ”€ æ£€æŸ¥ isLogin çŠ¶æ€
    â”œâ”€ æœªç™»å½• â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ
    â””â”€ å·²ç™»å½• â†’ åŠ è½½é¡µé¢å†…å®¹

æ‰€æœ‰ API è¯·æ±‚
    â”œâ”€ è‡ªåŠ¨æ³¨å…¥ tokenï¼ˆHTTP æ‹¦æˆªå™¨ï¼‰
    â”œâ”€ è·å¾— 401 â†’ è°ƒç”¨ refreshToken()
    â”œâ”€ refresh æˆåŠŸ â†’ é‡è¯•åŸè¯·æ±‚
    â””â”€ refresh å¤±è´¥ â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ
```

---

## åç»­ä¼˜åŒ–æ–¹å‘

1. **ç¤¾äº¤ç™»å½•æ‰©å±•** - æ”¯æŒæ”¯ä»˜å®ã€QQ ç­‰
2. **ç”Ÿç‰©è¯†åˆ«ç™»å½•** - äººè„¸è¯†åˆ«ã€æŒ‡çº¹è¯†åˆ«
3. **å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰** - å¤šåº”ç”¨ç»Ÿä¸€è®¤è¯
4. **ç™»å½•å†å²** - è®°å½•ç™»å½•è®¾å¤‡å’Œä½ç½®
5. **äºŒæ¬¡éªŒè¯** - æ•æ„Ÿæ“ä½œéœ€äºŒæ¬¡ç¡®è®¤
6. **è´¦å·ç»‘å®š** - å¾®ä¿¡å·ç»‘å®šæ‰‹æœºå·ç­‰

---

## å‚è€ƒèµ„æº

- [å¾®ä¿¡å°ç¨‹åºå®˜æ–¹æ–‡æ¡£ - ç™»å½•](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [å¾®ä¿¡å°ç¨‹åºå®˜æ–¹æ–‡æ¡£ - è·å–ç”¨æˆ·ä¿¡æ¯](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html)
- [JWT ä»‹ç»](https://jwt.io/)
- [HTTP çŠ¶æ€ç ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)

---

**Generated by AI Code Assistant**  
**Last Updated**: 2026-02-20  
**Status**: ğŸ”„ å¾…å¼€å‘  
**Priority**: ğŸ”´ P0 (æ ¸å¿ƒåŠŸèƒ½)
