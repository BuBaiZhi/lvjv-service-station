<view class="container">
  <!-- æœç´¢æ  -->
  <view class="header">
    <view class="search-bar" bindtap="onSearch">
      <text class="search-icon">ğŸ”</text>
      <text class="search-text">æœç´¢ç›®çš„åœ°ã€ç¤¾åŒºåç§°</text>
    </view>
    <view class="filter-btn" bindtap="onFilter">
      <text>ğŸ“‹</text>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <scroll-view class="filter-bar" scroll-x show-scrollbar="{{false}}">
    <view class="filter-list">
      <view class="filter-item {{currentSort === 'comprehensive' ? 'active' : ''}}" bindtap="onSort" data-sort="comprehensive">
        <text>ç»¼åˆ</text>
      </view>
      <view class="filter-item {{currentSort === 'latest' ? 'active' : ''}}" bindtap="onSort" data-sort="latest">
        <text>æœ€æ–°</text>
      </view>
      <view class="filter-item {{currentSort === 'price' ? 'active' : ''}}" bindtap="onSort" data-sort="price">
        <text>ä»·æ ¼æœ€ä½</text>
      </view>
      <view class="filter-item" bindtap="showPriceFilter">
        <text>ä»·æ ¼åŒºé—´</text>
        <text class="arrow">â–¼</text>
      </view>
      <view class="filter-item" bindtap="showFacilityFilter">
        <text>è®¾æ–½</text>
        <text class="arrow">â–¼</text>
      </view>
    </view>
  </scroll-view>

  <!-- ä»·æ ¼åŒºé—´å¼¹çª— -->
  <view class="filter-modal" wx:if="{{showPriceModal}}">
    <view class="modal-mask" bindtap="hidePriceFilter"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ä»·æ ¼åŒºé—´</text>
        <text class="close-btn" bindtap="hidePriceFilter">âœ•</text>
      </view>
      <view class="modal-body">
        <view class="price-range">
          <input class="price-input" type="number" placeholder="æœ€ä½ä»·" bindinput="onMinPrice" value="{{minPrice}}"></input>
          <text class="price-line">â€”</text>
          <input class="price-input" type="number" placeholder="æœ€é«˜ä»·" bindinput="onMaxPrice" value="{{maxPrice}}"></input>
        </view>
        <view class="range-buttons">
          <view class="range-btn" wx:for="{{priceRanges}}" wx:key="index" bindtap="selectPriceRange" data-min="{{item.min}}" data-max="{{item.max}}">{{item.text}}</view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="reset-btn" bindtap="resetPrice">é‡ç½®</button>
        <button class="confirm-btn" bindtap="applyPriceFilter">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è®¾æ–½ç­›é€‰å¼¹çª— -->
  <view class="filter-modal" wx:if="{{showFacilityModal}}">
    <view class="modal-mask" bindtap="hideFacilityFilter"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è®¾æ–½ç­›é€‰</text>
        <text class="close-btn" bindtap="hideFacilityFilter">âœ•</text>
      </view>
      <view class="modal-body">
        <view class="facility-list">
          <view class="facility-item" wx:for="{{facilities}}" wx:key="index">
            <label class="checkbox-label">
              <checkbox value="{{item}}" checked="{{selectedFacilities.includes(item)}}" bindchange="onFacilityChange" data-facility="{{item}}"></checkbox>
              <text class="facility-name">{{item}}</text>
            </label>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="reset-btn" bindtap="resetFacilities">é‡ç½®</button>
        <button class="confirm-btn" bindtap="applyFacilityFilter">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è§†å›¾åˆ‡æ¢ -->
  <view class="view-switch">
    <text class="result-count">å…± {{filteredHouses.length}} ä¸ªæˆ¿æº</text>
    <view class="switch-buttons">
      <view class="switch-btn {{viewMode === 'list' ? 'active' : ''}}" bindtap="switchView" data-mode="list">
        <text>ğŸ“‹</text>
        <text class="btn-text">åˆ—è¡¨</text>
      </view>
      <view class="switch-btn {{viewMode === 'map' ? 'active' : ''}}" bindtap="switchView" data-mode="map">
        <text>ğŸ—ºï¸</text>
        <text class="btn-text">åœ°å›¾</text>
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨æ¨¡å¼ -->
  <view class="list-mode" wx:if="{{viewMode === 'list'}}">
    <scroll-view 
      class="house-list" 
      scroll-y 
      enhanced
      show-scrollbar="{{false}}"
      refresher-enabled
      refresher-triggered="{{refreshing}}"
      bindrefresherrefresh="onRefresh"
      bindscrolltolower="onLoadMore"
    >
      <view class="house-card" wx:for="{{filteredHouses}}" wx:key="_id" bindtap="onHouseTap" data-id="{{item._id}}">
        <image class="house-image" src="{{item.image}}" mode="aspectFill"></image>
        <view class="house-info">
          <view class="house-header">
            <text class="house-title">{{item.title}}</text>
            <text class="house-price">Â¥{{item.price}}<text class="unit">/{{item.unit}}</text></text>
          </view>
          <view class="house-location">
            <text class="location-icon">ğŸ“</text>
            <text class="location-text">{{item.location}}</text>
            <text class="distance" wx:if="{{item.distance}}">{{item.distance}}</text>
          </view>
          <view class="house-rating" wx:if="{{item.rating}}">
            <text class="star">â­</text>
            <text class="score">{{item.rating}}</text>
            <text class="comment-count">{{item.commentCount}}æ¡è¯„ä»·</text>
          </view>
          <view class="house-tags">
            <text class="tag" wx:for="{{item.tags}}" wx:key="*this">#{{item}}</text>
          </view>
        </view>
      </view>
      
      <view class="load-more" wx:if="{{hasMore}}">
        <text>åŠ è½½ä¸­...</text>
      </view>
      <view class="no-more" wx:elif="{{filteredHouses.length > 0}}">
        <text>æ²¡æœ‰æ›´å¤šäº†</text>
      </view>
    </scroll-view>
  </view>

  <!-- åœ°å›¾æ¨¡å¼ -->
  <view class="map-mode" wx:else>
    <map
      id="map"
      class="map"
      latitude="{{latitude}}"
      longitude="{{longitude}}"
      scale="{{scale}}"
      markers="{{markers}}"
      bindmarkertap="onMarkerTap"
      show-location
    ></map>
    
    <view class="current-location" bindtap="onLocate">
      <text class="locate-icon">ğŸ“</text>
    </view>
    
    <view class="selected-card" wx:if="{{selectedHouse}}" catchtap="onSelectedCardTap">
      <image class="card-image" src="{{selectedHouse.image}}" mode="aspectFill"></image>
      <view class="card-info">
        <view class="card-header">
          <text class="card-title">{{selectedHouse.title}}</text>
          <text class="card-price">Â¥{{selectedHouse.price}}<text class="unit">/{{selectedHouse.unit}}</text></text>
        </view>
        <text class="card-location">{{selectedHouse.location}}</text>
        <view class="card-tags">
          <text class="card-tag" wx:for="{{selectedHouse.tags}}" wx:key="*this" wx:for-item="tag" wx:for-index="index" wx:if="{{index < 2}}">#{{tag}}</text>
        </view>
        <button class="view-detail-btn" catchtap="onViewDetail">æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>
  </view>
</view>