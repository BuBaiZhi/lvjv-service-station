<view class="container" data-theme="{{theme}}" data-elder="{{elderMode}}" style="background: var(--color-background); min-height: 100vh;">
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å¸–å­å†…å®¹ -->
  <view class="post-detail" wx:else>
    <!-- ä½œè€…ä¿¡æ¯ -->
    <view class="author-section">
      <view class="author-info" bindtap="onAuthorTap" data-author-id="{{post.author.id}}">
        <image class="avatar" src="{{post.author.avatar}}" mode="aspectFill"></image>
        <view class="author-detail">
          <view class="author-name">
            <text>{{post.author.name}}</text>
            <identity-badge identity="{{post.author.identity}}"></identity-badge>
            <text class="author-level" wx:if="{{post.author.level}}">Lv.{{post.author.level}}</text>
          </view>
          <view class="post-meta">
            <text class="post-time">{{formatTime(post.createTime)}}</text>
            <text class="post-views">ğŸ‘ï¸ {{formatNumber(post.views || 0)}}</text>
            <text class="post-location" wx:if="{{post.location}}">ğŸ“ {{post.location}}</text>
          </view>
        </view>
      </view>
      <view class="follow-btn" wx:if="{{!post.isSelf}}" bindtap="onFollow">
        <text>{{post.isFollowed ? 'å·²å…³æ³¨' : '+ å…³æ³¨'}}</text>
      </view>
    </view>

    <!-- å¸–å­ç±»å‹æ ‡ç­¾ -->
    <view class="post-type" wx:if="{{post.type}}">
      <text class="type-tag" data-type="{{post.type}}"># {{post.type}}</text>
    </view>
    
    <!-- æ ‡é¢˜ -->
    <view class="post-title" wx:if="{{post.title}}">
      {{post.title}}
    </view>
    
    <!-- æ­£æ–‡ -->
    <view class="post-content">
      {{post.content}}
    </view>
    
    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <view class="image-grid" wx:if="{{post.images && post.images.length > 0}}">
      <block wx:for="{{post.images}}" wx:key="index">
        <image 
          class="grid-image image-{{index}}"
          src="{{item}}"
          mode="aspectFill"
          bindtap="previewImage"
          data-index="{{index}}"
          data-images="{{post.images}}"
        ></image>
      </block>
    </view>
    
    <!-- æ ‡ç­¾åˆ—è¡¨ -->
    <view class="tags-container" wx:if="{{post.tags && post.tags.length > 0}}">
      <block wx:for="{{post.tags}}" wx:key="index">
        <text class="tag-item" bindtap="onTagTap" data-tag="{{item}}">#{{item}}</text>
      </block>
    </view>
    
    <!-- äº’åŠ¨ç»Ÿè®¡ -->
    <view class="stats-section">
      <view class="stat-item" bindtap="onLikesList">
        <text class="stat-number">{{formatNumber(post.likes)}}</text>
        <text class="stat-label">ç‚¹èµ</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{formatNumber(post.comments)}}</text>
        <text class="stat-label">è¯„è®º</text>
      </view>
      <view class="stat-item" bindtap="onCollectsList">
        <text class="stat-number">{{formatNumber(post.collects || 0)}}</text>
        <text class="stat-label">æ”¶è—</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{formatNumber(post.views || 0)}}</text>
        <text class="stat-label">æµè§ˆ</text>
      </view>
    </view>
    
    <!-- äº’åŠ¨æ  -->
    <view class="action-bar">
      <view class="action-item {{post.isLiked ? 'active' : ''}}" bindtap="onLike">
        <text class="action-icon">{{post.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text">{{post.isLiked ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}}</text>
      </view>
      <view class="action-item" bindtap="onComment">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-text">è¯„è®º</text>
      </view>
      <view class="action-item {{post.isCollected ? 'active' : ''}}" bindtap="onCollect">
        <text class="action-icon">{{post.isCollected ? 'â­' : 'â˜†'}}</text>
        <text class="action-text">{{post.isCollected ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-item" bindtap="onShare">
        <text class="action-icon">â†—ï¸</text>
        <text class="action-text">åˆ†äº«</text>
      </view>
    </view>

    <!-- ç›¸å…³æ¨è - å·²ä¿®å¤ -->
    <view class="related-section" wx:if="{{relatedPosts.length > 0}}">
      <view class="section-header">
        <text class="section-title">ç›¸å…³æ¨è</text>
        <text class="section-more" bindtap="onMoreRelated">æŸ¥çœ‹æ›´å¤š â€º</text>
      </view>
      <scroll-view class="related-list" scroll-x show-scrollbar="{{false}}">
        <view class="related-item" wx:for="{{relatedPosts}}" wx:key="id" bindtap="onRelatedTap" data-id="{{item._id}}">
          <!-- å·²ä¿®å¤ï¼šç”¨é¢„å¤„ç†å¥½çš„ coverImage -->
          <image class="related-image" src="{{item.coverImage}}" mode="aspectFill"></image>
          <view class="related-info">
            <!-- å·²ä¿®å¤ï¼šç”¨é¢„å¤„ç†å¥½çš„ shortTitle -->
            <text class="related-title">{{item.shortTitle}}</text>
            <view class="related-meta">
              <text>â¤ï¸ {{item.likes}}</text>
              <text>ğŸ’¬ {{item.comments}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- è¯„è®ºåŒºæ ‡é¢˜ -->
    <view class="comment-header">
      <text class="comment-title">å…¨éƒ¨è¯„è®º ({{post.comments}})</text>
      <text class="comment-sort" bindtap="toggleCommentSort">
        {{commentSort === 'hot' ? 'ğŸ”¥ çƒ­é—¨' : 'â° æœ€æ–°'}}
      </text>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comment-list">
      <block wx:for="{{comments}}" wx:key="id">
        <view class="comment-item" id="comment-{{item._id}}">
          <image 
            class="comment-avatar" 
            src="{{item.avatar}}" 
            mode="aspectFill"
            bindtap="onCommentAvatarTap"
            data-user-id="{{item.userId}}"
          ></image>
          <view class="comment-content">
            <view class="comment-info">
              <text class="comment-name">{{item.userName}}</text>
              <identity-badge wx:if="{{item.identity}}" identity="{{item.identity}}"></identity-badge>
              <text class="comment-time">{{formatTime(item.createTime)}}</text>
            </view>
            <text class="comment-text">{{item.content}}</text>
            
            <!-- å›å¤åˆ—è¡¨ -->
            <view class="reply-list" wx:if="{{item.replies && item.replies.length > 0}}">
              <block wx:for="{{item.replies}}" wx:key="id">
                <view class="reply-item">
                  <text class="reply-name">{{item.userName}}</text>
                  <text class="reply-text" wx:if="{{item.replyTo}}">å›å¤ {{item.replyTo}}ï¼š</text>
                  <text class="reply-content">{{item.content}}</text>
                </view>
              </block>
              <text class="more-replies" wx:if="{{item.replyCount > 2}}" bindtap="showAllReplies" data-id="{{item._id}}">
                æŸ¥çœ‹å…¨éƒ¨{{item.replyCount}}æ¡å›å¤
              </text>
            </view>
            
            <!-- è¯„è®ºäº’åŠ¨ -->
            <view class="comment-actions">
              <view class="action-btn" bindtap="onReply" data-id="{{item._id}}" data-name="{{item.userName}}">
                <text class="btn-icon">ğŸ’¬</text>
                <text class="btn-text">å›å¤</text>
              </view>
              <view class="action-btn" bindtap="onLikeComment" data-id="{{item._id}}">
                <text class="btn-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                <text class="btn-text">{{item.likeCount || ''}}</text>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- åº•éƒ¨è¾“å…¥æ¡† -->
    <view class="bottom-input" style="padding-bottom: {{safeAreaBottom}}rpx;">
      <image class="input-avatar" src="{{userAvatar}}" mode="aspectFill"></image>
      <view class="input-wrapper">
        <input 
          class="input-field"
          placeholder="{{replyPlaceholder || 'å†™è¯„è®º...'}}"
          bindinput="onInput"
          value="{{inputValue}}"
          confirm-type="send"
          bindconfirm="onSendComment"
          maxlength="500"
        ></input>
        <text class="word-count">{{inputValue.length}}/500</text>
      </view>
      <button class="send-btn" bindtap="onSendComment" disabled="{{!inputValue.trim()}}">å‘é€</button>
    </view>
  </view>
</view>
</view>